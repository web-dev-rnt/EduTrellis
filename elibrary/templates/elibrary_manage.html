{% extends "admin_dashboard.html" %}
{% load static %}

{% block content %}
{% include 'message.html' %}
<div class="wrapper">
    <h1 class="h1">E-Library Course Management</h1>
    <p class="small">Manage digital courses and PDF collections for students</p>

    <!-- Statistics using existing .admin-kpis -->
    <section class="admin-kpis">
        <div class="admin-kpi">
            <div class="admin-kpi-ico">üìö</div>
            <div>
                <div class="admin-kpi-label">Total Courses</div>
                <div class="admin-kpi-value">{{ stats.total_courses }}</div>
            </div>
        </div>
        <div class="admin-kpi">
            <div class="admin-kpi-ico">‚úÖ</div>
            <div>
                <div class="admin-kpi-label">Active Courses</div>
                <div class="admin-kpi-value">{{ stats.active_courses }}</div>
            </div>
        </div>
        <div class="admin-kpi">
            <div class="admin-kpi-ico">üë•</div>
            <div>
                <div class="admin-kpi-label">Enrollments</div>
                <div class="admin-kpi-value">{{ stats.total_enrollments }}</div>
            </div>
        </div>
        <div class="admin-kpi">
            <div class="admin-kpi-ico">üí∞</div>
            <div>
                <div class="admin-kpi-label">Total Revenue</div>
                <div class="admin-kpi-value">‚Çπ{{ stats.total_revenue|floatformat:0 }}</div>
            </div>
        </div>
    </section>

    <div class="panel">
        <!-- Navigation using existing .nav-buttons -->
        <div class="nav-buttons">
            <a href="{% url 'elibrary_course_create' %}" class="btn btn-primary">
                ‚ûï Create New Course
            </a>
            <a href="{% url 'manage_categories' %}" class="btn">
                üìÇ Manage Categories
            </a>
        </div>

        <!-- Filters using existing card header structure -->
        <div class="admin-card-hd">
            <h3>E-Library Courses</h3>
            <div class="admin-filters">
                <form method="get" style="display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end;">
                    <input 
                        type="text" 
                        name="search" 
                        value="{{ search_query }}" 
                        placeholder="Search courses, instructor, tags..." 
                        class="admin-filter-input"
                    />
                    <select name="category" class="admin-filter-select">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <select name="difficulty" class="admin-filter-select">
                        <option value="">All Levels</option>
                        {% for code, name in difficulty_choices %}
                            <option value="{{ code }}" {% if difficulty_filter == code %}selected{% endif %}>
                                {{ name }}
                            </option>
                        {% endfor %}
                    </select>
                    <select name="status" class="admin-filter-select">
                        <option value="">All Status</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                        <option value="free" {% if status_filter == 'free' %}selected{% endif %}>Free Courses</option>
                        <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>Paid Courses</option>
                    </select>
                    <button type="submit" class="admin-filter-btn">Filter</button>
                    {% if search_query or category_filter or difficulty_filter or status_filter %}
                        <a href="{% url 'elibrary_manage' %}" class="btn">Clear</a>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Course List using existing table styles -->
        <div class="admin-card-bd">
            {% if page_obj %}
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Category</th>
                                <th>Instructor</th>
                                <th>Price</th>
                                <th>PDFs</th>
                                <th>Enrollments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in page_obj %}
                            <tr class="user-row">
                                <td>
                                    <div class="user-info">
                                        {% if course.cover_image %}
                                            <img src="{{ course.cover_image.url }}" alt="{{ course.title }}" style="width: 50px; height: 35px; object-fit: cover; border-radius: 6px;">
                                        {% else %}
                                            <div style="width: 50px; height: 35px; background: var(--admin-primary-100); color: var(--admin-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold;">üìö</div>
                                        {% endif %}
                                        <div>
                                            <div class="user-name">{{ course.title }}</div>
                                            <div style="display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
                                                {% if course.is_free %}
                                                    <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600;">üéÅ FREE</span>
                                                {% endif %}
                                                {% if course.is_featured %}
                                                    <span class="badge" style="background: #fef3c7; color: #f59e0b;">Featured</span>
                                                {% endif %}
                                                {% if course.is_bestseller %}
                                                    <span class="badge" style="background: #fce7f3; color: #ec4899;">Bestseller</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ course.category.name }}</td>
                                <td>{{ course.instructor }}</td>
                                <td>
                                    <div class="date-cell">
                                        {% if course.is_free %}
                                            <span class="date-primary" style="color: #10b981; font-weight: 600;">FREE</span>
                                        {% else %}
                                            {% if course.has_discount %}
                                                <span class="date-primary" style="color: var(--admin-primary);">‚Çπ{{ course.current_price }}</span>
                                                <span class="date-secondary" style="text-decoration: line-through;">‚Çπ{{ course.price }}</span>
                                            {% else %}
                                                <span class="date-primary" style="color: var(--admin-primary);">‚Çπ{{ course.price }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ course.total_pdfs }}</td>
                                <td>{{ course.enrollment_count }}</td>
                                <td>
                                    {% if course.is_active %}
                                        <span class="status-badge status-active">Active</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'elibrary_course_detail' course.pk %}" class="action-btn" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'elibrary_course_edit' course.pk %}" class="action-btn" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'elibrary_toggle_course_status' course.pk %}" class="action-btn" title="{% if course.is_active %}Deactivate{% else %}Activate{% endif %}">
                                            <i class="fas fa-{% if course.is_active %}toggle-on{% else %}toggle-off{% endif %}"></i>
                                        </a>
                                        <button type="button" class="action-btn delete-course-btn" 
                                                data-course-id="{{ course.pk }}" 
                                                data-course-title="{{ course.title }}"
                                                data-course-pdfs="{{ course.total_pdfs }}"
                                                title="Delete Course" 
                                                style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 6px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Hidden Delete Form -->
                                    <form method="post" action="{% url 'elibrary_course_delete' course.pk %}" class="delete-form" id="delete-form-{{ course.pk }}" style="display: none;">
                                        {% csrf_token %}
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <div class="pagination-wrapper">
                        <div class="pagination-info">
                            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} courses
                        </div>
                        <div class="pagination">
                            {% if page_obj.has_previous %}
                                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if difficulty_filter %}&difficulty={{ difficulty_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-btn">First</a>
                                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if difficulty_filter %}&difficulty={{ difficulty_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-btn">Previous</a>
                            {% endif %}
                            
                            <span class="page-btn page-current">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                            
                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if difficulty_filter %}&difficulty={{ difficulty_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-btn">Next</a>
                                <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if difficulty_filter %}&difficulty={{ difficulty_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-btn">Last</a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state" style="text-align: center;">
                    <div class="empty-icon" style="font-size: 48px; margin-bottom: 16px;">üìö</div>
                    <h3 class="empty-title">No courses found</h3>
                    <p class="empty-text">
                        {% if search_query or category_filter or difficulty_filter or status_filter %}
                            Try adjusting your filters or 
                        {% endif %}
                        <a href="{% url 'elibrary_course_create' %}">create your first course</a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle delete button clicks for all courses
    const deleteButtons = document.querySelectorAll('.delete-course-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const courseId = this.getAttribute('data-course-id');
            const courseTitle = this.getAttribute('data-course-title');
            const coursePdfs = this.getAttribute('data-course-pdfs');
            
            // Show confirmation dialog
            const confirmed = confirm(
                `‚ö†Ô∏è DELETE ENTIRE COURSE?\n\n` +
                `Course: "${courseTitle}"\n` +
                `Total PDFs: ${coursePdfs}\n\n` +
                `This will permanently delete:\n` +
                `‚Ä¢ All ${coursePdfs} PDF files from storage\n` +
                `‚Ä¢ Course cover image and preview PDF\n` +
                `‚Ä¢ All enrollment records\n` +
                `‚Ä¢ All download statistics\n\n` +
                `Students will lose access to this content!\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Are you absolutely sure?`
            );
            
            if (confirmed) {
                // Submit the hidden form
                const form = document.getElementById(`delete-form-${courseId}`);
                if (form) {
                    form.submit();
                }
            }
        });
    });
});
</script>
{% endblock %}
