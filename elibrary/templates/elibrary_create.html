{% extends "admin_dashboard.html" %}
{% load static %}

{% block content %}
{% include 'message.html' %}
<div class="wrapper">
    <h1 class="h1">Create New E-Library Course</h1>
    <p class="small">Create a comprehensive digital course with multiple PDF resources</p>

    <div class="nav-buttons">
        <a href="{% url 'elibrary_manage' %}" class="btn">‚Üê Back to Courses</a>
    </div>

    <div class="panel">
        <form method="post" enctype="multipart/form-data" id="courseForm">
            {% csrf_token %}
            
            <div class="elibrary-form-grid">
                <div class="elibrary-main-column">
                    <fieldset class="form-fieldset">
                        <legend>Basic Information</legend>
                        
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">Course Title*</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <ul class="errorlist">{% for error in form.title.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.short_description.id_for_label }}">Short Description*</label>
                            {{ form.short_description }}
                            <div class="help-text">Brief description for course cards (max 300 characters)</div>
                            {% if form.short_description.errors %}
                                <ul class="errorlist">{% for error in form.short_description.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">Detailed Description*</label>
                            {{ form.description }}
                            <div class="help-text">Comprehensive course description for the course page</div>
                            {% if form.description.errors %}
                                <ul class="errorlist">{% for error in form.description.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="{{ form.category.id_for_label }}">Category*</label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <ul class="errorlist">{% for error in form.category.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="{{ form.difficulty_level.id_for_label }}">Difficulty Level*</label>
                                    {{ form.difficulty_level }}
                                    {% if form.difficulty_level.errors %}
                                        <ul class="errorlist">{% for error in form.difficulty_level.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="{{ form.instructor.id_for_label }}">Instructor*</label>
                                    {{ form.instructor }}
                                    {% if form.instructor.errors %}
                                        <ul class="errorlist">{% for error in form.instructor.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="{{ form.language.id_for_label }}">Language</label>
                                    {{ form.language }}
                                    {% if form.language.errors %}
                                        <ul class="errorlist">{% for error in form.language.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset">
                        <legend>Pricing</legend>
                        
                        <div class="form-group">
                            <label class="checkbox-label free-course-checkbox">
                                {{ form.is_free }}
                                <span>üéÅ Make this course FREE for all users</span>
                            </label>
                            <div class="help-text">Enable this to offer the course at no cost. Price fields will be optional.</div>
                            {% if form.is_free.errors %}
                                <ul class="errorlist">{% for error in form.is_free.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div id="pricingFields">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="{{ form.price.id_for_label }}">Price (‚Çπ)*</label>
                                        {{ form.price }}
                                        {% if form.price.errors %}
                                            <ul class="errorlist">{% for error in form.price.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="{{ form.discount_price.id_for_label }}">Discount Price (‚Çπ)</label>
                                        {{ form.discount_price }}
                                        <div class="help-text">Leave empty if no discount</div>
                                        {% if form.discount_price.errors %}
                                            <ul class="errorlist">{% for error in form.discount_price.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <div class="elibrary-sidebar-column">
                    <fieldset class="form-fieldset">
                        <legend>Media & Content</legend>
                        
                        <div class="form-group">
                            <label for="{{ form.cover_image.id_for_label }}">Cover Image</label>
                            {{ form.cover_image }}
                            <div class="help-text">Course thumbnail (recommended: 400x300px)</div>
                            {% if form.cover_image.errors %}
                                <ul class="errorlist">{% for error in form.cover_image.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.preview_pdf.id_for_label }}">Preview PDF</label>
                            {{ form.preview_pdf }}
                            <div class="help-text">Free preview for potential students</div>
                            {% if form.preview_pdf.errors %}
                                <ul class="errorlist">{% for error in form.preview_pdf.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.total_pages.id_for_label }}">Estimated Total Pages</label>
                            {{ form.total_pages }}
                            <div class="help-text">Approximate total pages across all PDFs</div>
                            {% if form.total_pages.errors %}
                                <ul class="errorlist">{% for error in form.total_pages.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.tags.id_for_label }}">Tags</label>
                            {{ form.tags }}
                            <div class="help-text">Comma-separated search keywords</div>
                            {% if form.tags.errors %}
                                <ul class="errorlist">{% for error in form.tags.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset">
                        <legend>Settings</legend>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                {{ form.is_featured }}
                                <span>Featured Course</span>
                            </label>
                            <div class="help-text">Display prominently on homepage</div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                {{ form.is_bestseller }}
                                <span>Mark as Bestseller</span>
                            </label>
                            <div class="help-text">Show bestseller badge</div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                {{ form.is_active }}
                                <span>Active Course</span>
                            </label>
                            <div class="help-text">Available for purchase</div>
                        </div>
                    </fieldset>
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary">Create Course</button>
                <a href="{% url 'elibrary_manage' %}" class="btn">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
/* E-Library Form Layout */
.elibrary-form-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    align-items: start;
}

.elibrary-main-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.elibrary-sidebar-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Form Row Layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-col {
    display: flex;
    flex-direction: column;
}

/* Fieldset Styling */
.form-fieldset {
    border: 1px solid var(--ad-border);
    padding: 20px;
    border-radius: var(--ad-radius-sm);
    background: var(--ad-panel);
}

.form-fieldset legend {
    font-weight: 800;
    font-size: 15px;
    color: var(--ad-text);
    padding: 0 12px;
    margin-bottom: 0;
    background: var(--ad-panel);
}

/* Checkbox Styling */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--ad-text);
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
    cursor: pointer;
}

.free-course-checkbox {
    padding: 12px;
    background: #f0fdf4;
    border: 2px solid #86efac;
    border-radius: 8px;
    font-weight: 500;
}

.free-course-checkbox span {
    font-size: 15px;
}

/* Pricing Fields Disabled State */
#pricingFields.disabled {
    opacity: 0.5;
    pointer-events: none;
}

/* Character Counter */
.char-counter {
    font-size: 12px;
    color: var(--ad-muted);
    margin-top: 4px;
    text-align: right;
}

.char-counter.warning {
    color: var(--ad-warning);
}

.char-counter.danger {
    color: var(--ad-danger);
}

/* Form Group Spacing */
.form-group {
    margin-bottom: 16px;
}

.form-group:last-child {
    margin-bottom: 0;
}

/* Help Text */
.help-text {
    font-size: 12px;
    color: var(--ad-muted);
    margin-top: 4px;
}

/* Actions */
.actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--ad-border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

/* Mobile Responsiveness */
@media (max-width: 968px) {
    .elibrary-form-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .actions {
        justify-content: stretch;
    }
    
    .actions .btn {
        flex: 1;
        text-align: center;
    }
}

@media (max-width: 640px) {
    .elibrary-form-grid {
        gap: 16px;
    }
    
    .form-fieldset {
        padding: 16px;
    }
    
    .actions {
        flex-direction: column-reverse;
    }
}

/* Ensure proper input styling */
input[type="text"], 
input[type="number"], 
textarea, 
select,
input[type="file"] {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    font-size: 14px;
    color: #1f2937;
    font-weight: 400;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    box-sizing: border-box;
}

input[type="text"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus,
input[type="file"]:focus {
    outline: none;
    border-color: var(--input-border-focus);
    box-shadow: 0 0 0 3px rgba(199,33,47,.1), 0 1px 2px rgba(0, 0, 0, 0.05);
    background: #ffffff;
}

/* Textarea specific */
textarea {
    resize: vertical;
    min-height: 80px;
}

/* Error styling */
.errorlist {
    color: var(--ad-danger);
    margin: 6px 0 0;
    font-size: 13px;
    list-style: none;
    padding: 0;
}

.errorlist li {
    margin-bottom: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Real-time character count for short description
    const shortDescField = document.querySelector('#id_short_description');
    if (shortDescField) {
        const maxLength = 300;
        const counter = document.createElement('div');
        counter.className = 'char-counter';
        
        function updateCounter() {
            const remaining = maxLength - shortDescField.value.length;
            counter.textContent = `${shortDescField.value.length}/${maxLength} characters`;
            
            if (remaining < 50) {
                counter.className = 'char-counter danger';
            } else if (remaining < 100) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
        }
        
        shortDescField.addEventListener('input', updateCounter);
        shortDescField.parentNode.appendChild(counter);
        updateCounter();
    }
    
    // Handle Free Course Toggle
    const isFreeCheckbox = document.querySelector('#id_is_free');
    const pricingFields = document.querySelector('#pricingFields');
    const priceInput = document.querySelector('#id_price');
    const discountPriceInput = document.querySelector('#id_discount_price');
    
    if (isFreeCheckbox && pricingFields) {
        function togglePricingFields() {
            if (isFreeCheckbox.checked) {
                pricingFields.classList.add('disabled');
                priceInput.value = '0.00';
                discountPriceInput.value = '';
                priceInput.removeAttribute('required');
            } else {
                pricingFields.classList.remove('disabled');
                priceInput.setAttribute('required', 'required');
                if (priceInput.value === '0.00') {
                    priceInput.value = '';
                }
            }
        }
        
        // Initial check
        togglePricingFields();
        
        // Listen for changes
        isFreeCheckbox.addEventListener('change', togglePricingFields);
    }
});
</script>
{% endblock %}
