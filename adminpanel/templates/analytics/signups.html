{% extends "admin_dashboard.html" %}
{% load static %}

{% block content %}
<main class="">
  <div class="page-header">
    <div class="header-content">
      <h1>Signup Analytics</h1>
      <p class="page-subtitle">Track and manage user registrations and analytics</p>
    </div>
  </div>
{% include "message.html" %}
  
  <!-- Statistics Cards -->
  <section class="admin-kpis">
    <div class="admin-kpi">
      <div class="admin-kpi-ico"><i class="fas fa-users" style="color: #007bff;"></i></div>
      <div>
        <div class="admin-kpi-label">Total Users</div>
        <div class="admin-kpi-value">{{ total_users }}</div>
        <div class="admin-kpi-change">+{{ total_growth }}% this month</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico"><i class="fas fa-chart-line" style="color: #28a745;"></i></div>
      <div>
        <div class="admin-kpi-label">This Month</div>
        <div class="admin-kpi-value">{{ this_month_signups }}</div>
        <div class="admin-kpi-change">{{ monthly_change }}% vs last month</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico"><i class="fas fa-user-tie" style="color: #ffc107;"></i></div>
      <div>
        <div class="admin-kpi-label">Staff Users</div>
        <div class="admin-kpi-value">{{ staff_users }}</div>
        <div class="admin-kpi-change">{{ staff_percentage }}% of total</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico"><i class="fas fa-check-circle" style="color: #28a745;"></i></div>
      <div>
        <div class="admin-kpi-label">Active Users</div>
        <div class="admin-kpi-value">{{ active_users }}</div>
        <div class="admin-kpi-change">{{ active_percentage }}% active</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico"><i class="fas fa-times-circle" style="color: #dc3545;"></i></div>
      <div>
        <div class="admin-kpi-label">Inactive Users</div>
        <div class="admin-kpi-value">{{ inactive_users }}</div>
        <div class="admin-kpi-change">{{ inactive_percentage }}% inactive</div>
      </div>
    </div>
  </section>

  <!-- User Details Table -->
  <section class="admin-card">
    <div class="admin-card-hd">
      <h3><i class="fas fa-users" style="color: #007bff;"></i> User Management</h3>
    </div>
    
    <!-- Advanced Filters -->
    <div class="advanced-filters">
      <form method="GET" class="filter-form">
        <div class="filter-row">
          <div class="filter-group">
            <input class="admin-filter-input" type="text" name="search" 
                   placeholder="Search users…" value="{{ request.GET.search }}">
          </div>
          <div class="filter-group">
            <select class="admin-filter-select" name="status" onchange="this.form.submit()">
              <option value="">All Status</option>
              <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
              <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
            </select>
          </div>
          <div class="filter-group">
            <select class="admin-filter-select" name="user_type" onchange="this.form.submit()">
              <option value="">All Types</option>
              <option value="staff" {% if request.GET.user_type == 'staff' %}selected{% endif %}>Staff</option>
              <option value="superuser" {% if request.GET.user_type == 'superuser' %}selected{% endif %}>Superuser</option>
            </select>
          </div>
          <div class="filter-group">
            <select class="admin-filter-select" name="date_range" onchange="this.form.submit()">
              <option value="">All Time</option>
              <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
              <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
              <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
              <option value="year" {% if request.GET.date_range == 'year' %}selected{% endif %}>This Year</option>
            </select>
          </div>
          <div class="filter-group">
            <button type="submit" class="admin-btn admin-btn-primary"><i class="fas fa-search"></i> Search</button>
            <a href="{% url 'signupdashboard' %}" class="admin-btn admin-btn-secondary"><i class="fas fa-sync"></i> Clear</a>
          </div>
        </div>
      </form>
    </div>

    <div class="admin-card-bd">
      <div class="table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>
                <a href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}sort=id&order={% if request.GET.sort == 'id' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">
                  User ID 
                  {% if request.GET.sort == 'id' %}
                    {% if request.GET.order == 'asc' %}↑{% else %}↓{% endif %}
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}sort=name&order={% if request.GET.sort == 'name' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">
                  Name
                  {% if request.GET.sort == 'name' %}
                    {% if request.GET.order == 'asc' %}↑{% else %}↓{% endif %}
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}sort=email&order={% if request.GET.sort == 'email' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">
                  Email
                  {% if request.GET.sort == 'email' %}
                    {% if request.GET.order == 'asc' %}↑{% else %}↓{% endif %}
                  {% endif %}
                </a>
              </th>
              <th>Contact</th>
              <th>
                <a href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}sort=date_joined&order={% if request.GET.sort == 'date_joined' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">
                  Signup Date
                  {% if request.GET.sort == 'date_joined' %}
                    {% if request.GET.order == 'asc' %}↑{% else %}↓{% endif %}
                  {% endif %}
                </a>
              </th>
              <th>Last Login</th>
              <th>Status</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr class="user-row" data-user-id="{{ user.id }}">
              <td class="user-id">{{ user.id|stringformat:"04d" }}</td>
              <td>
                <div class="user-info">
                  <div class="user-name">
                    {{ user.get_full_name|default:user.first_name|truncatechars:25 }}
                  </div>
                  {% if user.is_superuser %}
                    <span class="badge badge-super">SUPER</span>
                  {% elif user.is_staff %}
                    <span class="badge badge-staff">STAFF</span>
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="email-cell">
                  {{ user.email|truncatechars:30 }}
                  <button class="copy-btn" onclick="copyToClipboard('{{ user.email }}')" title="Copy email"><i class="fas fa-copy"></i></button>
                </div>
              </td>
              <td>
                {% if user.contact_number %}
                  <div class="contact-cell">
                    {{ user.contact_number }}
                    <button class="copy-btn" onclick="copyToClipboard('{{ user.contact_number }}')" title="Copy phone"><i class="fas fa-copy"></i></button>
                  </div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <div class="date-cell">
                  <div class="date-primary">{{ user.date_joined|date:"M d, Y" }}</div>
                </div>
              </td>
              <td>
                {% if user.last_login %}
                  <div class="date-cell">
                    <div class="date-primary">{{ user.last_login|date:"M d, Y" }}</div>
                  </div>
                {% else %}
                  <span class="text-muted">Never</span>
                {% endif %}
              </td>
              <td>
                {% if user.is_active %}
                  <span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>
                {% else %}
                  <span class="status-badge status-inactive"><i class="fas fa-times-circle"></i> Inactive</span>
                {% endif %}
              </td>
              <td>
                {% if user.is_superuser %}
                  <span class="type-badge type-super"><i class="fas fa-crown"></i> Superuser</span>
                {% elif user.is_staff %}
                  <span class="type-badge type-staff"><i class="fas fa-user-tie"></i> Staff</span>
                {% else %}
                  <span class="type-badge type-regular"><i class="fas fa-user"></i> Regular</span>
                {% endif %}
              </td>
              <td>
                <div class="action-buttons">
                  <a href="{% url 'edit_user' user.id %}" 
                     class="action-btn action-edit" title="Edit User"><i class="fas fa-edit"></i></a>
                  
                  <a href="{% url 'toggle_user_status' user.id %}" 
                     class="action-btn {% if user.is_active %}action-deactivate{% else %}action-activate{% endif %}" 
                     title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}">
                     {% if user.is_active %}<i class="fas fa-ban"></i>{% else %}<i class="fas fa-check"></i>{% endif %}
                  </a>
                  
                  <a href="{% url 'reset_user_password' user.id %}" 
                     class="action-btn" 
                     title="Reset Password">
                     <i class="fas fa-sync"></i>
                  </a>
                  
                  <a href="{% url 'delete_user' user.id %}" 
                     class="action-btn text-danger" 
                     title="Delete User"
                     onclick="return confirm('Are you sure you want to delete this user?')">
                     <i class="fas fa-trash"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center empty-state">
                <div class="empty-icon"><i class="fas fa-users" style="font-size: 48px; color: #ccc;"></i></div>
                <div class="empty-title">No users found</div>
                <div class="empty-text">Try adjusting your search criteria</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination-wrapper">
      <div class="pagination-info">
        Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} users
      </div>
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?page=1{{ request.GET|urlencode }}" class="page-btn"><i class="fas fa-fast-backward"></i> First</a>
          <a href="?page={{ page_obj.previous_page_number }}{{ request.GET|urlencode }}" class="page-btn"><i class="fas fa-chevron-left"></i> Prev</a>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <span class="page-btn page-current">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{{ request.GET|urlencode }}" class="page-btn">{{ num }}</a>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{{ request.GET|urlencode }}" class="page-btn">Next <i class="fas fa-chevron-right"></i></a>
          <a href="?page={{ page_obj.paginator.num_pages }}{{ request.GET|urlencode }}" class="page-btn">Last <i class="fas fa-fast-forward"></i></a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </section>
</main>

<script>
// Copy to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast('Copied to clipboard!');
  });
}

// Show toast notification
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--admin-success);
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
`;
document.head.appendChild(style);
</script>

{% endblock content %}
