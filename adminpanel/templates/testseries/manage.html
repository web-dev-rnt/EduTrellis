{% extends 'admin_dashboard.html' %}

{% block title %}Manage Test Series{% endblock %}
{% include "message.html" %}
{% block content %}
<div class="wrapper">
  {% include 'message.html' %}
  <h1 class="h1">Test Series Managements</h1>
  <p class="small">Create and manage all test series courses</p>

  <div class="nav-buttons">
    <a href="{% url 'test_series_create' %}" class="btn btn-primary">‚ûï Add Test Series courses</a>
  </div>

  <div class="panel">
    <div class="admin-card-hd">
      <h3>All test series courses</h3>
      <div class="admin-filters">
        <form method="GET" style="display: flex; gap: 8px;">
          <input type="text" name="search" class="admin-filter-input" placeholder="Search test series..." value="{{ search_query }}">
          <select name="category" class="admin-filter-select">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:'s' %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="admin-filter-btn">Filter</button>
        </form>
      </div>
    </div>

    <div class="admin-card-bd">
      {% if page_obj %}
        <table class="admin-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Category</th>
              <th>Tests</th>
              <th>Questions</th>
              <th>Total Marks</th>
              <th>Difficulty</th>
              <th>Price</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for series in page_obj %}
              <tr>
                <td>
                  <strong>{{ series.title }}</strong>
                  {% if series.is_featured %}
                    <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">FEATURED</span>
                  {% endif %}
                </td>
                <td>{{ series.category.name }}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">{{ series.total_tests }}</span>
                    {% if series.total_tests > 0 %}
                      <span style="color: #16a34a;">‚úì</span>
                    {% else %}
                      <span style="color: #dc2626;">‚ö†</span>
                    {% endif %}
                  </div>
                </td>
                <td>
                  <span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">{{ series.total_questions }}</span>
                </td>
                <td>
                  <span style="font-weight: 600; color: #059669;">{{ series.total_marks }}</span>
                </td>
                <td>
                  <span style="background: {% if series.difficulty == 'easy' %}#10b981{% elif series.difficulty == 'medium' %}#f59e0b{% else %}#dc2626{% endif %}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                    {{ series.get_difficulty_display }}
                  </span>
                </td>
                <td>
                  {% if series.is_free %}
                    <span style="color: #10b981; font-weight: 600;">FREE</span>
                  {% else %}
                    ‚Çπ{{ series.price }}
                  {% endif %}
                </td>
                <td>
                  {% if series.is_active %}
                    <span style="color: #10b981;">Active</span>
                  {% else %}
                    <span style="color: #dc2626;">Inactive</span>
                  {% endif %}
                </td>
                <td>
                  <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <a href="{% url 'test_series_detail' pk=series.pk %}" class="btn" style="padding: 4px 8px; font-size: 12px; background: #3b82f6; color: white;">üìã View</a>
                    <a href="{% url 'test_series_edit' pk=series.pk %}" class="btn" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è Edit</a>
                    <a href="{% url 'test_create' series_pk=series.pk %}" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">‚ûï Add Test</a>
                    <button type="button" class="btn" style="padding: 4px 8px; font-size: 12px; background: #dc2626; color: white; border: none; cursor: pointer; border-radius: 4px;" onclick="openDeleteModal('{% url 'test_series_delete' pk=series.pk %}', '{{ series.title|escapejs }}', '{{ series.total_tests }}', '{{ series.total_questions }}')">üóëÔ∏è Delete</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <div style="margin-top: 20px; text-align: center;">
            <div style="display: inline-flex; gap: 8px;">
              {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&category={{ category_filter }}" class="btn">Previous</a>
              {% endif %}
              
              <span style="padding: 8px 12px;">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
              </span>
              
              {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&category={{ category_filter }}" class="btn">Next</a>
              {% endif %}
            </div>
          </div>
        {% endif %}

      {% else %}
        <div style="text-align: center; padding: 40px;">
          <p>No test series found.</p>
          <a href="{% url 'test_series_create' %}" class="btn btn-primary">Create First Test Series</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease;">
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
        <span style="font-size: 28px;">‚ö†Ô∏è</span>
      </div>
      <h3 style="margin: 0 0 8px; color: #1f2937; font-size: 20px;">Delete Test Series</h3>
      <p style="margin: 0; color: #6b7280; font-size: 14px;">This action cannot be undone.</p>
    </div>

    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
      <p style="margin: 0 0 8px; font-weight: 600; color: #dc2626; font-size: 14px;">You are about to delete:</p>
      <p style="margin: 0 0 5px; color: #1f2937; font-weight: 600;" id="deleteSeriesTitle"></p>
      <p style="margin: 0; color: #6b7280; font-size: 13px;" id="deleteSeriesInfo"></p>
    </div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button type="button" onclick="closeDeleteModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; color: #374151; font-weight: 500;">Cancel</button>
      <form id="deleteForm" method="POST" style="margin: 0;">
        {% csrf_token %}
        <button type="submit" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">üóëÔ∏è Yes, Delete</button>
      </form>
    </div>
  </div>
</div>

<style>
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

<script>
  function openDeleteModal(deleteUrl, seriesTitle, totalTests, totalQuestions) {
    document.getElementById('deleteSeriesTitle').textContent = seriesTitle;
    document.getElementById('deleteSeriesInfo').textContent = totalTests + ' test(s) and ' + totalQuestions + ' question(s) will also be deleted.';
    document.getElementById('deleteForm').action = deleteUrl;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  // Close modal when clicking outside
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDeleteModal();
    }
  });
</script>
{% endblock %}