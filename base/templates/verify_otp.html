{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="verification-page">
  <div class="verification-container">
    <div class="verification-card">
      <div class="verification-form-container">
        <div class="login-welcome">Verify Your Email</div>
        
        <div class="verification-info">
          <i class="fa fa-envelope-o"></i>
          <p>We've sent a 6-digit verification code to</p>
          <strong>{{ user.email }}</strong>
          <p class="helper-text">Please check your inbox and enter the code below</p>
        </div>

        <!-- Flash messages -->
        {% if messages %}
          <ul class="django-messages">
            {% for message in messages %}
              <li class="msg-{{ message.tags }}">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        <form class="login-form" id="otpForm" method="post" action="{% url 'verify_otp' %}">
          {% csrf_token %}
          
          <div class="input-wrapper">
            {{ form.otp_code }}
            {% if form.otp_code.errors %}
              <div class="error">{{ form.otp_code.errors }}</div>
            {% endif %}
          </div>

          <button type="submit" class="login-btn" id="verifyBtn">
            <span class="btn-label">Verify Email</span>
            <span class="btn-spinner" id="verifySpinner" style="display:none;margin-left:8px;">
              <span class="spinner"></span>
            </span>
          </button>

          <div class="resend-section">
            <p>Didn't receive the code?</p>
            <button type="button" id="resendBtn" class="resend-btn">
              <span id="resendText">Resend OTP</span>
              <span id="resendSpinner" style="display:none;">
                <i class="fa fa-spinner fa-spin"></i> Sending...
              </span>
            </button>
          </div>

          <div class="login-signup">
            <a href="{% url 'signup' %}">‚Üê Back to Signup</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.verification-page {
  padding: 40px 20px;
  background: transparent;
}

.verification-container {
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}

.verification-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  overflow: hidden;
  border-top: 4px solid #c1272d;
}

.verification-form-container {
  padding: 40px;
}

.login-welcome {
  font-size: 28px;
  font-weight: 700;
  color: #c1272d;
  margin-bottom: 30px;
  text-align: center;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.5);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
}

@keyframes spin { 
  to { transform: rotate(360deg); } 
}

.verification-info {
  text-align: center;
  margin-bottom: 25px;
  padding: 20px;
  background: #fff5f5;
  border-radius: 8px;
  border-left: 4px solid #c1272d;
}

.verification-info i {
  font-size: 32px;
  color: #c1272d;
  margin-bottom: 10px;
}

.verification-info p {
  margin: 5px 0;
  color: #6c757d;
}

.verification-info strong {
  color: #c1272d;
  font-size: 16px;
}

.helper-text {
  font-size: 13px !important;
  color: #6c757d !important;
  margin-top: 8px !important;
}

.otp-input {
  text-align: center;
  font-size: 24px;
  letter-spacing: 8px;
  font-weight: bold;
  padding: 15px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  width: 100%;
  font-family: 'Courier New', monospace;
  transition: all 0.3s ease;
}

.otp-input:focus {
  border-color: #c1272d;
  box-shadow: 0 0 0 0.2rem rgba(193, 39, 45, 0.25);
  outline: none;
}

.login-btn {
  width: 100%;
  padding: 14px;
  background: #c1272d;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 20px;
}

.login-btn:hover:not(:disabled) {
  background: #a02228;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(193, 39, 45, 0.4);
}

.login-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.resend-section {
  text-align: center;
  margin-top: 25px;
  padding: 15px;
  background: #fff5f5;
  border-radius: 6px;
}

.resend-section p {
  margin: 0 0 8px 0;
  color: #6c757d;
  font-size: 14px;
}

.resend-btn {
  background: none;
  border: none;
  color: #c1272d;
  cursor: pointer;
  text-decoration: underline;
  font-size: 14px;
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.2s;
}

.resend-btn:hover:not(:disabled) {
  color: #a02228;
  background: rgba(193, 39, 45, 0.1);
  text-decoration: none;
}

.resend-btn:disabled {
  color: #6c757d;
  cursor: not-allowed;
  text-decoration: none;
  background: none;
}

.error { 
  color: #c1272d; 
  font-size: 13px; 
  margin-top: 8px;
  text-align: center; 
}

.login-signup {
  text-align: center;
  margin-top: 20px;
}

.login-signup a {
  color: #6c757d;
  text-decoration: none;
  font-size: 14px;
  transition: color 0.2s ease;
}

.login-signup a:hover {
  color: #c1272d;
  text-decoration: underline;
}

/* Django messages */
.django-messages {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}

.django-messages li {
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 10px;
  font-size: 14px;
}

.msg-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.msg-error {
  background: #ffe6e6;
  color: #c1272d;
  border: 1px solid #ffcccc;
}

.msg-info {
  background: #fff5f5;
  color: #c1272d;
  border: 1px solid #ffdddd;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .verification-page {
    padding: 30px 20px;
  }
  
  .verification-form-container {
    padding: 30px 25px;
  }
  
  .login-welcome {
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .verification-page {
    padding: 20px 15px;
  }
  
  .verification-form-container {
    padding: 25px 20px;
  }
  
  .otp-input {
    font-size: 20px;
    letter-spacing: 4px;
    padding: 12px;
  }
  
  .verification-info {
    padding: 15px;
  }
  
  .verification-info i {
    font-size: 28px;
  }
  
  .login-welcome {
    font-size: 22px;
  }
}
</style>

<script>
(function() {
  const form = document.getElementById('otpForm');
  const verifyBtn = document.getElementById('verifyBtn');
  const verifySpinner = document.getElementById('verifySpinner');
  const verifyLabel = verifyBtn.querySelector('.btn-label');
  
  const resendBtn = document.getElementById('resendBtn');
  const resendText = document.getElementById('resendText');
  const resendSpinner = document.getElementById('resendSpinner');

  // Form submission
  if (form) {
    form.addEventListener('submit', function() {
      verifyBtn.disabled = true;
      verifyBtn.classList.add('is-loading');
      verifyLabel.textContent = 'Verifying...';
      verifySpinner.style.display = 'inline-block';
    });
  }

  // Resend OTP with enhanced UX
  if (resendBtn) {
    resendBtn.addEventListener('click', function() {
      resendBtn.disabled = true;
      resendText.style.display = 'none';
      resendSpinner.style.display = 'inline';

      fetch('{% url "resend_otp" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          showNotification(data.message, 'success');
          
          // Start countdown
          let countdown = 60;
          const interval = setInterval(() => {
            resendText.textContent = `Resend OTP (${countdown}s)`;
            countdown--;
            if (countdown < 0) {
              clearInterval(interval);
              resendBtn.disabled = false;
              resendText.textContent = 'Resend OTP';
            }
          }, 1000);
        } else {
          showNotification('Error: ' + data.message, 'error');
          resendBtn.disabled = false;
        }
      })
      .catch(error => {
        showNotification('Network error. Please try again.', 'error');
        resendBtn.disabled = false;
      })
      .finally(() => {
        resendText.style.display = 'inline';
        resendSpinner.style.display = 'none';
      });
    });
  }

  // Auto-focus and input formatting
  const otpInput = document.getElementById('{{ form.otp_code.id_for_label }}');
  if (otpInput) {
    otpInput.focus();
    
    otpInput.addEventListener('input', function(e) {
      // Only allow numbers
      this.value = this.value.replace(/[^0-9]/g, '');
      
      // Auto-submit when 6 digits entered (optional)
      if (this.value.length === 6) {
        // Uncomment next line to auto-submit
        // form.submit();
      }
    });

    // Handle paste events
    otpInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      const numbers = paste.replace(/[^0-9]/g, '').substring(0, 6);
      this.value = numbers;
      
      if (numbers.length === 6) {
        // Uncomment next line to auto-submit on paste
        // form.submit();
      }
    });
  }

  // Utility function for notifications
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
      ${message}
    `;
    
    // Add styles
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#d4edda' : '#ffe6e6'};
      color: ${type === 'success' ? '#155724' : '#c1272d'};
      border: 1px solid ${type === 'success' ? '#c3e6cb' : '#ffcccc'};
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      animation: slideInRight 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 4 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }

  // Add CSS animations for notifications
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
})();
</script>

{% endblock %}
