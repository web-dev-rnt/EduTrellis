{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }} - eLibrary</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #c7212f;
            --primary-dark: #ad1830;
            --text: #162033;
            --muted: #707793;
            --border: #e9ecf3;
            --bg: #fafbff;
            --success: #28a745;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        
        /* Header Section */
        .course-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            padding: 32px 20px;
            box-shadow: 0 4px 16px rgba(199, 33, 47, 0.15);
        }

        .course-header.free {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
        }

        .course-header.purchased {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        }

        .course-header .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .hero-thumb {
            width: 380px;
            max-width: 42vw;
            aspect-ratio: 16/9;
            border-radius: 14px;
            overflow: hidden;
            background: #000;
            flex-shrink: 0;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .hero-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-info { 
            flex: 1; 
            min-width: 0; 
        }

        .hero-info h1 {
            font-size: 28px;
            margin-bottom: 12px;
            line-height: 1.3;
            font-weight: 800;
        }

        .hero-meta {
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .hero-meta i {
            margin-right: 4px;
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
        }

        .badge-featured { 
            background: #8246ef; 
            color: #fff;
        }

        .badge-bestseller { 
            background: #fbbf24; 
            color: #78350f; 
        }

        .badge-free { 
            background: rgba(255,255,255,.25);
            color: #fff;
        }

        .badge-purchased {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .price-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .price-now {
            font-size: 32px;
            font-weight: 900;
        }

        .price-old {
            font-size: 18px;
            text-decoration: line-through;
            opacity: .7;
            font-weight: 600;
            margin-left: 8px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
            transition: all .3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #fff;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.25);
        }

        .btn-primary:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 255, 255, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary.free {
            background: #fff;
            color: var(--success);
        }

        .btn-primary.purchased {
            background: #fff;
            color: var(--success);
            cursor: default;
        }

        .btn-primary.purchased:hover {
            transform: none;
        }

        .btn-enrolled {
            background: #fff;
            color: var(--success);
            cursor: default;
        }

        .btn-enrolled:hover {
            transform: none;
        }

        .back {
            position: fixed;
            top: 20px;
            left: 20px;
            background: transparent;
            color: #fff;
            border: none;
            font-size: 28px;
            cursor: pointer;
            z-index: 999;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back:hover {
            transform: translateX(-3px);
        }
        
        /* Access Expiry Alert */
        .access-expiry-alert {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .access-expiry-alert i {
            color: #ff6b6b;
            font-size: 18px;
        }

        /* Main */
        .main {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 24px;
        }

        .panel {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }

        .panel h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 16px;
            color: var(--text);
            border-bottom: 2px solid #f0f0f6;
            padding-bottom: 10px;
        }

        .panel h3 {
            font-size: 16px;
            margin: 20px 0 12px;
            color: var(--text);
            font-weight: 700;
        }

        .desc {
            color: #42436b;
            line-height: 1.7;
            font-size: 15px;
        }
        
        /* Chapters */
        .chapter {
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chapter:hover {
            box-shadow: 0 4px 12px rgba(199, 33, 47, 0.08);
        }

        .chapter-head {
            background: #f8f9fa;
            padding: 18px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all .2s;
        }

        .chapter-head:hover {
            background: #fff;
            border-left: 3px solid var(--primary);
        }

        .chapter-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--text);
        }

        .chapter-count {
            font-size: 13px;
            color: var(--muted);
            margin-top: 4px;
        }

        .chapter-icon {
            color: var(--primary);
            font-size: 20px;
            transition: transform .3s;
        }

        .chapter-icon.open {
            transform: rotate(180deg);
        }

        .chapter-body {
            display: none;
            padding: 16px 20px;
            background: #fff;
        }

        .chapter-body.open {
            display: block;
        }
        
        /* PDF Item */
        .pdf {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #f7f9fc;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: all .3s ease;
        }

        .pdf:hover {
            border-color: #8246ef;
            box-shadow: 0 2px 8px rgba(130,70,239,.1);
            transform: translateX(4px);
        }

        .pdf-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .pdf-icon {
            color: var(--primary);
            font-size: 24px;
            flex-shrink: 0;
        }

        .pdf-info {
            flex: 1;
            min-width: 0;
        }

        .pdf-name {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pdf-meta {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .pdf-preview {
            background: var(--success);
            color: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .pdf-locked {
            background: #fbbf24;
            color: #78350f;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .pdf-btns {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .pdf-btn {
            background: #8246ef;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .pdf-btn:hover {
            background: #6a35c7;
            color: #fff;
            transform: translateY(-2px);
        }

        .pdf-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Sidebar */
        .sidebar {
            position: sticky;
            top: 20px;
        }

        .info-box {
            background: #f8fafc;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-box p {
            margin: 8px 0;
            font-size: 14px;
            color: #42436b;
        }

        .info-box strong {
            color: var(--text);
        }

        .instructor {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            padding: 14px;
            background: #f9f9fb;
            border-radius: 12px;
        }

        .instructor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .instructor-info h3 {
            margin: 0 0 4px;
            font-size: 16px;
            color: var(--text);
        }

        .instructor-info p {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
        }

        .includes {
            list-style: none;
            padding: 0;
        }

        .includes li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f6;
            font-size: 14px;
            color: #42436b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .includes li:last-child {
            border: none;
        }

        .includes i {
            color: #8246ef;
            font-size: 16px;
            width: 20px;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-primary.loading .spinner {
            display: inline-block;
        }

        .btn-primary.loading .btn-text {
            display: none;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .toast.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 980px) {
            .course-header .container {
                flex-direction: column;
            }

            .hero-thumb {
                width: 100%;
                max-width: 100%;
            }

            .main {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            .pdf {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .pdf-btns {
                width: 100%;
            }

            .pdf-btn {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 600px) {
            .hero-info h1 {
                font-size: 22px;
            }

            .back {
                top: 10px;
                left: 10px;
                font-size: 24px;
            }

            .price-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>

<a href="javascript:history.back()" class="back">
    <i class="fa fa-arrow-left"></i>
</a>

<!-- Hero -->
<section class="course-header {% if is_purchased %}purchased{% elif course.is_free %}free{% endif %}">
    <div class="container">
        <div class="hero-thumb">
            {% if course.cover_image %}
                <img src="{{ course.cover_image.url }}" alt="{{ course.title }}">
            {% else %}
                <img src="https://via.placeholder.com/380x214/f0f0f0/c7212f?text={{ course.title|slice:':1'|upper }}" alt="{{ course.title }}">
            {% endif %}
        </div>
        <div class="hero-info">
            <h1>{{ course.title }}</h1>
            <div class="hero-meta">
                <span><i class="fa fa-book"></i> {{ course.instructor }}</span>
                <span><i class="fa fa-file-pdf"></i> {{ course.total_pdfs }} PDF{{ course.total_pdfs|pluralize }}</span>
                <span><i class="fa fa-language"></i> {{ course.language }}</span>
            </div>
            <div class="badges">
                {% if is_purchased %}
                    <span class="badge badge-purchased">
                        <i class="fa fa-check-circle"></i> Course Purchased
                    </span>
                {% elif course.is_free %}
                    <span class="badge badge-free">
                        <i class="fa fa-unlock"></i> FREE
                    </span>
                {% endif %}
                {% if course.is_featured %}
                    <span class="badge badge-featured">Premium</span>
                {% endif %}
                {% if course.is_bestseller %}
                    <span class="badge badge-bestseller">Bestseller</span>
                {% endif %}
                <span class="badge" style="background: rgba(255,255,255,.25); color: #fff;">{{ course.get_difficulty_level_display }}</span>
            </div>
            
            <div class="price-row">
                <div class="price-main">
                    {% if is_purchased %}
                        <span style="color: #fff; font-size: 24px;"><i class="fa fa-check"></i> Access Granted</span>
                    {% elif course.is_free %}
                        <span>FREE</span>
                    {% else %}
                        ₹{{ course.current_price }}
                        {% if course.has_discount %}
                            <span class="price-old">₹{{ course.price }}</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Access Expiry Alert -->
            {% if is_purchased and access_expires_at %}
                <div class="access-expiry-alert">
                    <i class="fa fa-clock"></i>
                    <div>
                        <strong>Access Expires:</strong> {{ access_expires_at|date:"d M Y H:i" }}
                    </div>
                </div>
            {% endif %}

            <div class="price-row">
                {% if user.is_authenticated %}
                    {% if is_purchased %}
                        <button class="btn btn-primary btn-enrolled" disabled>
                            <i class="fa fa-check-circle"></i> Already Purchased
                        </button>
                    {% elif course.is_free %}
                        <button class="btn btn-primary free" id="enrollBtn" onclick="handleEnrollment()">
                            <div class="spinner"></div>
                            <span class="btn-text"><i class="fa fa-check"></i> Enroll Free</span>
                        </button>
                    {% else %}
                        <button class="btn btn-primary" id="enrollBtn" onclick="handleEnrollment()">
                            <div class="spinner"></div>
                            <span class="btn-text"><i class="fa fa-shopping-cart"></i> Enroll Now</span>
                        </button>
                    {% endif %}
                {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fa fa-lock"></i> Login to {% if course.is_free %}Enroll{% else %}Purchase{% endif %}
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Main -->
<section class="main">
    <!-- Left -->
    <div>
        <div class="panel">
            <h2>About This Course</h2>
            <div class="desc">{{ course.description|linebreaks }}</div>
        </div>

        {% if chapters %}
        <div class="panel" style="margin-top: 24px;">
            <h2>Course Content 
                <span style="color: var(--muted); font-weight: 400; font-size: 16px;">
                    ({{ course.total_pdfs }} PDF{{ course.total_pdfs|pluralize }} in {{ chapters|length }} chapter{{ chapters|length|pluralize }})
                </span>
            </h2>
            
            {% for chapter_num, pdfs in chapters.items %}
            <div class="chapter">
                <div class="chapter-head" onclick="toggleChap({{ chapter_num }})">
                    <div>
                        <div class="chapter-title">Chapter {{ chapter_num }}</div>
                        <div class="chapter-count">{{ pdfs|length }} PDF{{ pdfs|length|pluralize }}</div>
                    </div>
                    <i class="fa fa-chevron-down chapter-icon" id="icon-{{ chapter_num }}"></i>
                </div>
                <div class="chapter-body" id="body-{{ chapter_num }}">
                    {% for pdf in pdfs %}
                    <div class="pdf">
                        <div class="pdf-left">
                            <i class="fa fa-file-pdf pdf-icon"></i>
                            <div class="pdf-info">
                                <div class="pdf-name">
                                    {{ pdf.title }}
                                    {% if pdf.is_preview %}
                                        <span class="pdf-preview"><i class="fa fa-unlock"></i> Free Preview</span>
                                    {% elif not is_purchased %}
                                        <span class="pdf-locked"><i class="fa fa-lock"></i> Locked</span>
                                    {% endif %}
                                </div>
                                <div class="pdf-meta">
                                    {% if pdf.page_count %}<i class="fa fa-file"></i> {{ pdf.page_count }} pages{% endif %}
                                    {% if pdf.file_size %}· {{ pdf.file_size }}{% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="pdf-btns">
                            {% if is_purchased or pdf.is_preview %}
                                <a href="{% url 'view_pdf' pdf.id %}" class="pdf-btn" target="_blank">
                                    <i class="fa fa-eye"></i> View
                                </a>
                                <a href="{% url 'download_pdf' pdf.id %}" class="pdf-btn">
                                    <i class="fa fa-download"></i> Download
                                </a>
                            {% else %}
                                <button class="pdf-btn" disabled>
                                    <i class="fa fa-lock"></i> Locked
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="panel" style="margin-top: 24px;">
            <p style="color: var(--muted); text-align: center; padding: 40px;">No content available yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Right -->
    <aside class="sidebar">
        <div class="panel">
            <h2>Course Info</h2>
            <div class="info-box">
                <p><strong><i class="fa fa-book"></i> Course:</strong> {{ course.title }}</p>
                <p><strong><i class="fa fa-user"></i> Instructor:</strong> {{ course.instructor }}</p>
                <p><strong><i class="fa fa-folder"></i> Category:</strong> {{ course.category.name }}</p>
                <p><strong><i class="fa fa-language"></i> Language:</strong> {{ course.language }}</p>
                <p><strong><i class="fa fa-file-pdf"></i> PDFs:</strong> {{ course.total_pdfs }}</p>
                {% if course.total_pages %}
                <p><strong><i class="fa fa-file-text"></i> Pages:</strong> ~{{ course.total_pages }}</p>
                {% endif %}
                <p><strong><i class="fa fa-chart-line"></i> Level:</strong> {{ course.get_difficulty_level_display }}</p>
                <p><strong><i class="fa fa-users"></i> Enrolled:</strong> {{ course.enrollment_count|default:"0" }}</p>
            </div>

            <h3>Instructor</h3>
            <div class="instructor">
                <div class="instructor-avatar">{{ course.instructor|slice:':1'|upper }}</div>
                <div class="instructor-info">
                    <h3>{{ course.instructor }}</h3>
                    <p>{{ course.get_difficulty_level_display }} Level Expert</p>
                </div>
            </div>

            <h3>Course Includes</h3>
            <ul class="includes">
                <li><i class="fa fa-file-pdf"></i> {{ course.total_pdfs }} PDF Documents</li>
                <li><i class="fa fa-download"></i> Downloadable Resources</li>
                <li><i class="fa fa-mobile"></i> Mobile & Desktop Access</li>
                <li><i class="fa fa-infinity"></i> Lifetime Access</li>
                {% if preview_pdfs %}
                <li><i class="fa fa-eye"></i> {{ preview_pdfs.count }} Free Preview{{ preview_pdfs.count|pluralize }}</li>
                {% endif %}
                {% if course.total_pages %}
                <li><i class="fa fa-file-text"></i> ~{{ course.total_pages }} Total Pages</li>
                {% endif %}
            </ul>
        </div>
    </aside>
</section>

<script>
const isPurchased = {{ is_purchased|yesno:'true,false' }};
const isFree = {{ course.is_free|yesno:'true,false' }};

function toggleChap(num) {
    const body = document.getElementById(`body-${num}`);
    const icon = document.getElementById(`icon-${num}`);
    body.classList.toggle('open');
    icon.classList.toggle('open');
}

function handleEnrollment() {
    const btn = document.getElementById('enrollBtn');
    btn.disabled = true;
    
    // Show loading state based on course type
    if (isFree) {
        btn.innerHTML = '<span class="spinner"></span> Enrolling...';
    } else {
        btn.innerHTML = '<span class="spinner"></span> Processing...';
    }
    
    // Create payment order
    fetch("{% url 'create_payment_order' 'elibrary' course.pk %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to create order');
        }
        
        // If free course, reload page
        if (data.is_free) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
            return;
        }
        
        // Open Razorpay checkout for paid courses
        openRazorpayCheckout(data);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(error.message, 'error');
        resetEnrollButton();
    });
}

function openRazorpayCheckout(data) {
    const options = {
        key: data.razorpay_merchant_key,
        amount: data.amount,
        currency: data.currency,
        name: "{{ request.site.name|default:'EduPlatform' }}",
        description: data.course_name,
        order_id: data.razorpay_order_id,
        prefill: {
            name: data.user_name,
            email: data.user_email,
            contact: data.user_phone || ''
        },
        theme: {
            color: "#c7212f"
        },
        handler: function(response) {
            verifyPayment(response);
        },
        modal: {
            ondismiss: function() {
                resetEnrollButton();
                showToast('Payment cancelled by user.', 'info');
            },
            escape: false
        }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
    
    // Reset button after opening Razorpay (they'll handle the loading state)
    resetEnrollButton();
}

function verifyPayment(response) {
    const btn = document.getElementById('enrollBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Verifying...';

    fetch("{% url 'payment_handler' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'razorpay_payment_id': response.razorpay_payment_id,
            'razorpay_order_id': response.razorpay_order_id,
            'razorpay_signature': response.razorpay_signature
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast('Payment verification failed: ' + data.error, 'error');
            resetEnrollButton();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error processing payment response.', 'error');
        resetEnrollButton();
    });
}

function resetEnrollButton() {
    const btn = document.getElementById('enrollBtn');
    if (btn) {
        btn.disabled = false;
        if (isFree) {
            btn.innerHTML = '<i class="fa fa-check"></i> Enroll Free';
        } else {
            btn.innerHTML = '<i class="fa fa-shopping-cart"></i> Enroll Now';
        }
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

</body>
</html>