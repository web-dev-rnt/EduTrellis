{% extends 'admin_dashboard.html' %}
{% load static %}

{% block title %}Manage Product Bundles{% endblock %}

{% block content %}
<div class="wrapper">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="h1">Product Bundles</h1>
      <p class="page-subtitle">Create and manage product bundles with custom pricing</p>
    </div>
    <a href="{% url 'bundle_create' %}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Create New Bundle
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- KPI Cards -->
  <div class="admin-kpis">
    <div class="admin-kpi">
      <div class="admin-kpi-ico" style="background: #fef2f2; color: #c7212f;">
        <i class="fas fa-boxes"></i>
      </div>
      <div>
        <div class="admin-kpi-label">Total Bundles</div>
        <div class="admin-kpi-value">{{ total_bundles }}</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico" style="background: #f0fdf4; color: #16a34a;">
        <i class="fas fa-check-circle"></i>
      </div>
      <div>
        <div class="admin-kpi-label">Active Bundles</div>
        <div class="admin-kpi-value">{{ active_bundles }}</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico" style="background: #fef3c7; color: #f59e0b;">
        <i class="fas fa-star"></i>
      </div>
      <div>
        <div class="admin-kpi-label">Featured</div>
        <div class="admin-kpi-value">{{ featured_bundles }}</div>
      </div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-ico" style="background: #dbeafe; color: #2563eb;">
        <i class="fas fa-gift"></i>
      </div>
      <div>
        <div class="admin-kpi-label">Free Bundles</div>
        <div class="admin-kpi-value">{{ free_bundles|default:0 }}</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="advanced-filters">
    <form method="get" class="filter-form">
      <div class="filter-row">
        {{ filter_form.search }}
        {{ filter_form.category }}
        {{ filter_form.bundle_type }}
        {{ filter_form.status }}
        {{ filter_form.is_free }}
        <button type="submit" class="admin-filter-btn">
          <i class="fas fa-search"></i> Filter
        </button>
      </div>
    </form>
  </div>

  <!-- Bundles Table -->
  <div class="panel">
    <div class="table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Bundle</th>
            <th>Type</th>
            <th>Category</th>
            <th>Products</th>
            <th>Pricing</th>
            <th>Discount</th>
            <th>Status</th>
            <th>Enrollments</th>
            <th style="width: 160px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for bundle in bundles %}
          <tr class="user-row">
            <td>
              <div class="user-info">
                {% if bundle.thumbnail %}
                  <img src="{{ bundle.thumbnail.url }}" alt="{{ bundle.title }}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                {% else %}
                  <div style="width: 50px; height: 50px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-box-open" style="color: #9ca3af;"></i>
                  </div>
                {% endif %}
                <div>
                  <div class="user-name">{{ bundle.title }}</div>
                  <div style="font-size: 12px; color: var(--admin-muted); display: flex; gap: 4px; flex-wrap: wrap; align-items: center;">
                    {% if bundle.is_free %}
                      <span class="badge" style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 4px;">
                        <i class="fas fa-gift"></i> FREE
                      </span>
                    {% endif %}
                    {% if bundle.is_featured %}<i class="fas fa-star" style="color: #f59e0b;"></i>{% endif %}
                    {% if bundle.is_bestseller %}<span class="badge" style="background: #dbeafe; color: #1e40af;">Bestseller</span>{% endif %}
                    {% if bundle.is_trending %}<span class="badge" style="background: #fef3c7; color: #92400e;">Trending</span>{% endif %}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <span class="type-badge type-regular">{{ bundle.get_bundle_type_display }}</span>
            </td>
            <td>
              {% if bundle.category %}
                {{ bundle.category.name }}
              {% else %}
                <span style="color: var(--admin-muted);">No Category</span>
              {% endif %}
            </td>
            <td>
              <div style="font-weight: 600;">{{ bundle.total_products }} Products</div>
              <div style="font-size: 11px; color: var(--admin-muted);">
                {% if bundle.video_courses.count %}<i class="fas fa-video"></i> {{ bundle.video_courses.count }} {% endif %}
                {% if bundle.live_classes.count %}<i class="fas fa-chalkboard-teacher"></i> {{ bundle.live_classes.count }} {% endif %}
                {% if bundle.test_series.count %}<i class="fas fa-clipboard"></i> {{ bundle.test_series.count }} {% endif %}
                {% if bundle.elibrary_courses.count %}<i class="fas fa-book"></i> {{ bundle.elibrary_courses.count }} {% endif %}
              </div>
            </td>
            <td>
              {% if bundle.is_free %}
                <div style="font-weight: 700; color: #16a34a; font-size: 16px;">FREE</div>
                <div style="font-size: 11px; color: var(--admin-muted);">No charge</div>
              {% else %}
                <div style="font-weight: 600; color: var(--admin-primary);">₹{{ bundle.bundle_price }}</div>
                <div style="font-size: 12px; color: var(--admin-muted); text-decoration: line-through;">₹{{ bundle.original_price }}</div>
              {% endif %}
            </td>
            <td>
              {% if bundle.is_free %}
                <span class="status-badge" style="background: #d1fae5; color: #065f46;">
                  <i class="fas fa-gift"></i> 100% FREE
                </span>
              {% else %}
                <span class="status-badge" style="background: #dcfce7; color: #16a34a;">
                  {{ bundle.discount_percentage }}% OFF
                </span>
              {% endif %}
            </td>
            <td>
              {% if bundle.status == 'active' %}
                <span class="status-badge status-active">
                  <i class="fas fa-check-circle"></i> Active
                </span>
              {% elif bundle.status == 'inactive' %}
                <span class="status-badge status-inactive">
                  <i class="fas fa-times-circle"></i> Inactive
                </span>
              {% elif bundle.status == 'draft' %}
                <span class="status-badge" style="background: #f3f4f6; color: #6b7280;">
                  <i class="fas fa-edit"></i> Draft
                </span>
              {% else %}
                <span class="status-badge" style="background: #fef3c7; color: #92400e;">
                  <i class="fas fa-archive"></i> Archived
                </span>
              {% endif %}
            </td>
            <td>
              <div style="font-weight: 600;">{{ bundle.current_enrollments }}</div>
              {% if bundle.max_enrollments %}
                <div style="font-size: 11px; color: var(--admin-muted);">of {{ bundle.max_enrollments }}</div>
              {% else %}
                <div style="font-size: 11px; color: var(--admin-muted);">unlimited</div>
              {% endif %}
            </td>
            <td>
              <div class="action-buttons" style="gap: 4px; flex-wrap: wrap;">
                <a href="{% url 'bundle_detail' bundle.pk %}" class="action-btn" title="View Details">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="{% url 'bundle_edit' bundle.pk %}" class="action-btn" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'bundle_toggle_status' bundle.pk %}" class="action-btn" title="Toggle Status">
                  <i class="fas fa-toggle-on"></i>
                </a>
                <button type="button" class="action-btn delete-btn" title="Delete" onclick="confirmDelete('{{ bundle.title|escapejs }}', '{% url 'bundle_delete' bundle.pk %}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state" style="text-align: center; padding: 40px;">
                <div class="empty-icon" style="font-size: 48px; color: var(--admin-muted); margin-bottom: 16px;">
                  <i class="fas fa-box-open"></i>
                </div>
                <div class="empty-title">No bundles found</div>
                <div class="empty-text">Create your first product bundle to get started</div>
                <a href="{% url 'bundle_create' %}" class="btn btn-primary" style="margin-top: 16px;">
                  <i class="fas fa-plus"></i> Create Bundle
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if bundles.has_other_pages %}
    <div class="pagination-wrapper">
      <div class="pagination-info">
        Showing {{ bundles.start_index }} to {{ bundles.end_index }} of {{ bundles.paginator.count }} bundles
      </div>
      <div class="pagination">
        {% if bundles.has_previous %}
          <a href="?page=1" class="page-btn"><i class="fas fa-angle-double-left"></i></a>
          <a href="?page={{ bundles.previous_page_number }}" class="page-btn"><i class="fas fa-angle-left"></i></a>
        {% endif %}
        
        {% for num in bundles.paginator.page_range %}
          {% if bundles.number == num %}
            <span class="page-btn page-current">{{ num }}</span>
          {% elif num > bundles.number|add:'-3' and num < bundles.number|add:'3' %}
            <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
          {% endif %}
        {% endfor %}
        
        {% if bundles.has_next %}
          <a href="?page={{ bundles.next_page_number }}" class="page-btn"><i class="fas fa-angle-right"></i></a>
          <a href="?page={{ bundles.paginator.num_pages }}" class="page-btn"><i class="fas fa-angle-double-right"></i></a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
/* Bundle Action Buttons Custom Styling */
.action-buttons {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
}

.action-btn {
  padding: 6px 8px;
  border: 1px solid var(--admin-border);
  background: white;
  cursor: pointer;
  border-radius: 6px;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s;
  color: var(--admin-text);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.action-btn:hover {
  background: var(--admin-panel-2);
  border-color: var(--admin-primary);
  color: var(--admin-primary);
}

.delete-btn {
  border-color: #fecaca;
  color: #dc2626;
}

.delete-btn:hover {
  background: #fef2f2;
  border-color: #dc2626;
  color: #dc2626;
}

/* Improve table cell spacing for actions */
.admin-table td:last-child {
  position: relative;
  overflow: visible;
}
</style>

<script>
function confirmDelete(bundleTitle, deleteUrl) {
  if (confirm('Are you sure you want to delete the bundle "' + bundleTitle + '"?\n\nThis action cannot be undone and will permanently remove:\n- Bundle information\n- Product associations\n- All enrollment data\n- Reviews and ratings')) {
    window.location.href = deleteUrl;
  }
}
</script>
{% endblock %}
