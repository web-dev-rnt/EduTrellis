{% extends "admin_dashboard.html" %}
{% include message.html %}
{% block content %}


<main>
  <div class="page-header">
    <div class="header-content">
      <h1>{% if course %}Edit Video Course{% else %}Create Video Course{% endif %}</h1>
      <p class="page-subtitle">Enter the course name first, upload videos, then fill remaining details. You can edit later.</p>
    </div>
  </div>


  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="message {% if message.tags == 'error' %}error{% else %}success{% endif %}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}


  <div class="wrapper">
    <!-- Create/Edit Form -->
    <form method="post" enctype="multipart/form-data" id="courseForm">
      {% csrf_token %}


      <!-- 1) Course Identity -->
      <div class="panel">
        <div class="panel-title">Course Identity</div>
        <div class="grid">
          <div class="col-6">
            <label>Course Name</label>
            {{ form.name }} 
            {% if form.name.errors %}<ul class="errorlist">{% for error in form.name.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-6">
            <label>Category</label>
            {{ form.category }} 
            {% if form.category.errors %}<ul class="errorlist">{% for error in form.category.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
        </div>
      </div>


      <!-- 2) Videos -->
      <div class="panel">
        <div class="panel-title">Videos</div>
        <p class="small">Upload your lessons. Duration is auto-detected after upload. Mark "Preview" if applicable.</p>
        {{ video_fs.management_form }}
        {% for v in video_fs %}
          <div class="coupon-card">
            {{ v.id }}
            <div class="grid">
              <div class="col-6">
                <label>Title</label>
                {{ v.title }} 
                {% if v.title.errors %}<ul class="errorlist">{% for error in v.title.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
              </div>
              <div class="col-3">
                <div class="form-group">
                  <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                    {{ v.is_preview }} <span>Preview?</span>
                  </label>
                </div>
              </div>
              <div class="col-3"></div>
              <div class="col-6">
                <label>Video File</label>
                {{ v.file }} 
                {% if v.file.errors %}<ul class="errorlist">{% for error in v.file.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
              </div>
              <div class="col-6">
                <label>Thumb Image</label>
                {{ v.thumb_image }} 
                {% if v.thumb_image.errors %}<ul class="errorlist">{% for error in v.thumb_image.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
              </div>
              {% if v.instance.pk %}
                <div class="col-12">
                  <div class="form-group">
                    <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                      {{ v.DELETE }} <span>Delete</span>
                    </label>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        <div class="actions">
          <button type="button" class="btn" onclick="addFormset('vid')">
            <i class="fas fa-plus"></i> Add Video
          </button>
        </div>
        <div class="message" style="margin-top: 12px;">
          <strong>ðŸ’¡ Tip:</strong> If you have many videos, scroll down to see all video upload forms. You can add multiple videos by clicking the "+ Add Video" button above.
        </div>
      </div>


      <!-- 3) Core Details -->
      <div class="panel">
        <div class="panel-title">Core Details</div>
        <div class="grid">
          <div class="col-12">
            <label>Description</label>
            {{ form.description }} 
            {% if form.description.errors %}<ul class="errorlist">{% for error in form.description.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-4">
            <label>Original Price</label>
            {{ form.original_price }} 
            {% if form.original_price.errors %}<ul class="errorlist">{% for error in form.original_price.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-4">
            <label>Selling Price</label>
            {{ form.selling_price }} 
            {% if form.selling_price.errors %}<ul class="errorlist">{% for error in form.selling_price.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-4">
            <label>Currency</label>
            {{ form.currency }} 
            {% if form.currency.errors %}<ul class="errorlist">{% for error in form.currency.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-6">
            <label>Thumbnail</label>
            {{ form.thumbnail }} 
            {% if form.thumbnail.errors %}<ul class="errorlist">{% for error in form.thumbnail.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            <div class="help-text">Recommended 16:9 image.</div>
          </div>
          <div class="col-6"></div>
        </div>
        <hr style="height: 1px; background: var(--ad-border); margin: 12px 0; border: none;">
        <div class="grid">
          <div class="col-3">
            <div class="form-group">
              <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                {{ form.is_free }} <span>Free Course</span>
              </label>
              <div class="help-text" style="font-size: 12px; margin-top: 4px;">
                {% if form.is_free.help_text %}
                  {{ form.is_free.help_text|safe }}
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="form-group">
              <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                {{ form.is_premium }} <span>Premium</span>
              </label>
            </div>
          </div>
          <div class="col-3">
            <div class="form-group">
              <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                {{ form.is_bestseller }} <span>Bestseller</span>
              </label>
            </div>
          </div>
          <div class="col-3"></div>
          <div class="col-2">
            <label>Rating</label>{{ form.rating }} 
            {% if form.rating.errors %}<ul class="errorlist">{% for error in form.rating.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-2">
            <label>Rating Count</label>{{ form.rating_count }} 
            {% if form.rating_count.errors %}<ul class="errorlist">{% for error in form.rating_count.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-2">
            <label>Total Hours</label>{{ form.total_hours }} 
            {% if form.total_hours.errors %}<ul class="errorlist">{% for error in form.total_hours.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
        </div>
      </div>


      <!-- 4) What you'll learn -->
      <div class="panel">
        <div class="panel-title">What you'll learn</div>
        {{ learn_fs.management_form }}
        {% for f in learn_fs %}
          <div class="coupon-card">
            {{ f.id }}
            <div class="grid">
              <div class="col-12">
                <label>Point</label>
                {{ f.text }} 
                {% if f.text.errors %}<ul class="errorlist">{% for error in f.text.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
              </div>
              {% if f.instance.pk %}
                <div class="col-12">
                  <div class="form-group">
                    <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                      {{ f.DELETE }} <span>Delete</span>
                    </label>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        <div class="actions">
          <button type="button" class="btn" onclick="addFormset('learn')">
            <i class="fas fa-plus"></i> Add Point
          </button>
        </div>
      </div>


      <!-- 5) Includes -->
      <div class="panel">
        <div class="panel-title">Includes</div>
        {{ include_fs.management_form }}
        {% for f in include_fs %}
          <div class="coupon-card">
            {{ f.id }}
            <div class="grid">
              <div class="col-12">
                <label>Label</label>
                {{ f.label }} 
                {% if f.label.errors %}<ul class="errorlist">{% for error in f.label.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
              </div>
              {% if f.instance.pk %}
                <div class="col-12">
                  <div class="form-group">
                    <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                      {{ f.DELETE }} <span>Delete</span>
                    </label>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        <div class="actions">
          <button type="button" class="btn" onclick="addFormset('incl')">
            <i class="fas fa-plus"></i> Add Include
          </button>
        </div>
      </div>


      <!-- 6) Instructor -->
      <div class="panel">
        <div class="panel-title">Instructor</div>
        <div class="grid">
          <div class="col-6">
            <label>Name</label>
            {{ form.instructor_name }} 
            {% if form.instructor_name.errors %}<ul class="errorlist">{% for error in form.instructor_name.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-6">
            <label>Headline</label>
            {{ form.instructor_headline }} 
            {% if form.instructor_headline.errors %}<ul class="errorlist">{% for error in form.instructor_headline.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-6">
            <label>Avatar</label>
            {{ form.instructor_avatar }} 
            {% if form.instructor_avatar.errors %}<ul class="errorlist">{% for error in form.instructor_avatar.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
          </div>
          <div class="col-6"></div>
        </div>
      </div>


      <div class="panel">
        <div class="actions">
          <button type="submit" class="btn btn-primary" id="saveCourseBtn">
            <span class="btn-icon">
              {% if mode == 'edit' %}<i class="fas fa-save"></i>{% else %}<i class="fas fa-save"></i>{% endif %}
            </span>
            <span class="btn-text">
              {% if mode == 'edit' %}Update Course{% else %}Save Course{% endif %}
            </span>
          </button>
        </div>
      </div>
    </form>
  </div>
</main>


<script>
// Enhanced notification system
function showNotification(message, type = 'success', duration = 4000) {
  const existingNotifications = document.querySelectorAll('.custom-notification');
  existingNotifications.forEach(notification => notification.remove());
  
  const notification = document.createElement('div');
  notification.className = `custom-notification custom-notification-${type}`;
  
  let bgColor, textColor, icon;
  switch(type) {
    case 'success':
      bgColor = '#f0fdf4';
      textColor = '#16a34a';
      icon = '<i class="fas fa-check-circle"></i>';
      break;
    case 'error':
      bgColor = '#fef2f2';
      textColor = '#dc2626';
      icon = '<i class="fas fa-exclamation-circle"></i>';
      break;
    case 'info':
      bgColor = '#eff6ff';
      textColor = '#2563eb';
      icon = '<i class="fas fa-info-circle"></i>';
      break;
    default:
      bgColor = '#f9fafb';
      textColor = '#374151';
      icon = '<i class="fas fa-bell"></i>';
  }
  
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="color: ${textColor};">${icon}</span>
      <span style="flex: 1;">${message}</span>
      <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: ${textColor}; opacity: 0.6;">Ã—</button>
    </div>
  `;
  
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
    min-width: 300px;
    background: ${bgColor};
    color: ${textColor};
    border: 1px solid ${type === 'success' ? '#bbf7d0' : type === 'error' ? '#fecaca' : '#bfdbfe'};
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    font-size: 14px;
    font-weight: 500;
    animation: slideInRight 0.3s ease-out;
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }
  }, duration);
}


// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  @keyframes fadeOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.95); }
  }
  
  .custom-notification:hover {
    transform: translateX(-5px);
    transition: transform 0.2s ease;
  }
`;
document.head.appendChild(style);


// Duplicate the last form row for a given inline formset prefix
function addFormset(prefix){
  const total = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
  if(!total) return;
  const count = parseInt(total.value, 10);

  const panels = Array.from(document.querySelectorAll(".panel"));
  let target = null;
  for (const p of panels) {
    if (p.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`)) { target = p; break; }
  }
  if(!target) return;
  const items = target.querySelectorAll(".coupon-card");
  const last = items[items.length - 1];
  if(!last) return;

  const clone = last.cloneNode(true);

  clone.querySelectorAll("[name]").forEach(el => {
    el.name = el.name.replace(new RegExp(`${prefix}-\\d+-`), `${prefix}-${count}-`);
    if(el.id) el.id = el.id.replace(new RegExp(`${prefix}-\\d+-`), `${prefix}-${count}-`);
    if(el.type === "checkbox"){ el.checked = false; }
    else if(el.type === "file"){ el.value = ""; }
    else if(el.tagName.toLowerCase() === "select"){ el.selectedIndex = 0; }
    else { el.value = ""; }
  });

  clone.querySelectorAll(".errorlist").forEach(e => e.remove());

  last.after(clone);
  total.value = count + 1;
  
  clone.scrollIntoView({ behavior: 'smooth', block: 'center' });
}


// Add loader to Save Course button
document.getElementById('courseForm').addEventListener('submit', function(e) {
  const btn = document.getElementById('saveCourseBtn');
  const icon = btn.querySelector('.btn-icon');
  const text = btn.querySelector('.btn-text');
  
  btn.classList.add('btn-loading');
  icon.innerHTML = '<div class="spinner"></div>';
  text.textContent = 'Saving...';
  
  btn.disabled = true;
});


// Show existing Django messages as notifications on page load
document.addEventListener('DOMContentLoaded', function() {
  const messageElements = document.querySelectorAll('.messages .message');
  messageElements.forEach(messageEl => {
    const messageType = messageEl.classList.contains('error') ? 'error' : 'success';
    const messageText = messageEl.textContent.trim();
    if (messageText) {
      showNotification(messageText, messageType);
      messageEl.style.display = 'none';
    }
  });
});
</script>
{% endblock content %}
