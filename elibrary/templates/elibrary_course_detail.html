{% extends "admin_dashboard.html" %}
{% load static %}

{% block content %}
{% include 'message.html' %}
<style>
/* Two Column Layout Container */
.course-detail-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.course-main-content {
    flex: 1;
    min-width: 0;
}

.course-sidebar {
    width: 320px;
    flex-shrink: 0;
}

/* Info Grid */
.info-grid {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.info-column {
    flex: 1;
}

/* Chapter Content */
.chapter-section {
    margin-bottom: 24px;
}

.chapter-header {
    color: var(--ad-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 2px solid var(--ad-primary-100);
}

.chapter-content {
    background: var(--ad-panel-2);
    border-radius: 8px;
    padding: 16px;
}

.pdf-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: white;
    border-radius: 6px;
    margin-bottom: 8px;
    border: 1px solid var(--ad-border);
}

.pdf-icon {
    width: 40px;
    height: 40px;
    background: #fee2e2;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dc2626;
    font-weight: bold;
    font-size: 12px;
    flex-shrink: 0;
}

.pdf-info {
    flex: 1;
    min-width: 0;
}

.pdf-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

/* Stats Vertical Layout */
.stats-vertical {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Description Box */
.description-box {
    margin-top: 8px;
    padding: 16px;
    background: var(--ad-panel-2);
    border-radius: 8px;
    line-height: 1.6;
}

/* Tags Container */
.tags-container {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

/* Cover Image */
.cover-image {
    width: 100%;
    border-radius: 8px;
    display: block;
}

/* Full Width Button */
.btn-full {
    width: 100%;
    text-align: center;
    display: block;
}

/* Delete Form (Hidden) */
.delete-form {
    display: none;
}

/* Free Badge Styling */
.free-badge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* Price Display */
.price-display {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

/* Responsive */
@media (max-width: 992px) {
    .course-detail-container {
        flex-direction: column;
    }
    
    .course-sidebar {
        width: 100%;
    }
    
    .info-grid {
        flex-direction: column;
    }
}

@media (max-width: 640px) {
    .pdf-item {
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .pdf-actions {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>

<div class="wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="h1">{{ course.title }}</h1>
            <p class="page-subtitle">{{ course.short_description }}</p>
        </div>
        <div class="filter-group">
            {% if course.is_free %}
                <span class="free-badge">üéÅ FREE</span>
            {% endif %}
            {% if course.is_featured %}
                <span class="badge" style="background: #fef3c7; color: #f59e0b;">Featured</span>
            {% endif %}
            {% if course.is_bestseller %}
                <span class="badge" style="background: #fce7f3; color: #ec4899;">Bestseller</span>
            {% endif %}
            {% if course.is_active %}
                <span class="status-badge status-active">Active</span>
            {% else %}
                <span class="status-badge status-inactive">Inactive</span>
            {% endif %}
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <a href="{% url 'elibrary_manage' %}" class="btn">‚Üê Back to Courses</a>
        <a href="{% url 'elibrary_course_edit' course.pk %}" class="btn btn-primary">Edit Course</a>
        <a href="{% url 'elibrary_pdf_upload_multiple' course.pk %}" class="btn btn-success">üìé Upload PDFs</a>
    </div>

    <!-- Two Column Layout -->
    <div class="course-detail-container">
        <!-- Left Column - Main Content -->
        <div class="course-main-content">
            <!-- Course Overview Panel -->
            <div class="panel">
                <h3 class="panel-title">Course Information</h3>
                
                <div class="info-grid">
                    <div class="info-column">
                        <div class="form-group">
                            <strong>Instructor:</strong> {{ course.instructor }}
                        </div>
                        <div class="form-group">
                            <strong>Category:</strong> {{ course.category.name }}
                        </div>
                        <div class="form-group">
                            <strong>Difficulty:</strong> {{ course.get_difficulty_level_display }}
                        </div>
                        <div class="form-group">
                            <strong>Language:</strong> {{ course.language }}
                        </div>
                    </div>
                    <div class="info-column">
                        <div class="form-group">
                            <strong>Price:</strong> 
                            <div class="price-display">
                                {% if course.is_free %}
                                    <span class="free-badge">FREE</span>
                                {% else %}
                                    {% if course.has_discount %}
                                        <span class="current-price">‚Çπ{{ course.current_price }}</span>
                                        <del class="original-price">‚Çπ{{ course.price }}</del>
                                        <span class="badge" style="background: #dcfce7; color: var(--ad-success);">({{ course.discount_percentage }}% off)</span>
                                    {% else %}
                                        <span class="current-price">‚Çπ{{ course.price }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            <strong>Total PDFs:</strong> {{ course.total_pdfs }}
                        </div>
                        <div class="form-group">
                            <strong>Total Pages:</strong> ~{{ course.total_pages }}
                        </div>
                        <div class="form-group">
                            <strong>Created:</strong> {{ course.created_at|date:"M d, Y" }}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <strong>Description:</strong>
                    <div class="description-box">
                        {{ course.description|linebreaks }}
                    </div>
                </div>

                {% if course_tags %}
                <div class="form-group">
                    <strong>Tags:</strong>
                    <div class="tags-container">
                        {% for tag in course_tags %}
                            <span class="badge" style="background: #e5e7eb; color: #374151;">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- PDF Content Panel -->
            <div class="panel">
                <div class="ad-card-hd">
                    <h3 class="panel-title">Course Content ({{ course.total_pdfs }} PDFs)</h3>
                    <a href="{% url 'elibrary_pdf_upload_multiple' course.pk %}" class="btn btn-success">+ Add PDFs</a>
                </div>
                
                {% if pdfs_by_chapter %}
                    {% for chapter_num, pdfs in pdfs_by_chapter.items %}
                    <div class="chapter-section">
                        <h4 class="chapter-header">
                            üìö Chapter {{ chapter_num }}
                        </h4>
                        <div class="chapter-content">
                            {% for pdf in pdfs %}
                            <div class="pdf-item">
                                <div class="user-info">
                                    <div class="pdf-icon">PDF</div>
                                    <div class="pdf-info">
                                        <div class="user-name">{{ pdf.title }}</div>
                                        <div class="date-secondary">
                                            {{ pdf.file_size }} 
                                            {% if pdf.page_count %} ‚Ä¢ {{ pdf.page_count }} pages{% endif %}
                                            ‚Ä¢ {{ pdf.download_count }} downloads
                                            {% if pdf.is_preview %} ‚Ä¢ <span style="color: var(--ad-success);">Free Preview</span>{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="pdf-actions">
                                    {% if pdf.file %}
                                        <a href="{{ pdf.file.url }}" target="_blank" class="action-btn" title="View PDF">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% else %}
                                        <span class="action-btn" style="color: #9ca3af; cursor: not-allowed;" title="File not available">
                                            <i class="fas fa-eye-slash"></i>
                                        </span>
                                    {% endif %}
                                    <button type="button" class="action-btn delete-pdf-btn" 
                                            data-pdf-id="{{ pdf.pk }}" 
                                            data-pdf-title="{{ pdf.title }}"
                                            title="Delete PDF" 
                                            style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 6px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <span class="status-badge {% if pdf.is_active %}status-active{% else %}status-inactive{% endif %}">
                                        {% if pdf.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </div>
                                
                                <!-- Hidden Delete Form -->
                                <form method="post" action="{% url 'elibrary_pdf_delete' pdf.pk %}" class="delete-form" id="delete-form-{{ pdf.pk }}">
                                    {% csrf_token %}
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìö</div>
                        <h3 class="empty-title">No PDFs uploaded yet</h3>
                        <p class="empty-text"><a href="{% url 'elibrary_pdf_upload_multiple' course.pk %}">Upload your first PDF files</a> to start building this course</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column - Sidebar -->
        <div class="course-sidebar">
            <!-- Course Statistics Panel -->
            <div class="panel">
                <h3 class="panel-title">Course Statistics</h3>
                
                <div class="stats-vertical">
                    <div class="ad-kpi">
                        <div class="ad-kpi-ico" style="background: var(--ad-primary-100); color: var(--ad-primary);">üë•</div>
                        <div>
                            <div class="ad-kpi-value">{{ enrollment_stats.total }}</div>
                            <div class="ad-kpi-label">Total Enrollments</div>
                        </div>
                    </div>
                    <div class="ad-kpi">
                        <div class="ad-kpi-ico" style="background: #dcfce7; color: var(--ad-success);">‚úÖ</div>
                        <div>
                            <div class="ad-kpi-value">{{ enrollment_stats.completed }}</div>
                            <div class="ad-kpi-label">Paid Enrollments</div>
                        </div>
                    </div>
                    <div class="ad-kpi">
                        <div class="ad-kpi-ico" style="background: #fef3c7; color: var(--ad-warning);">‚è≥</div>
                        <div>
                            <div class="ad-kpi-value">{{ enrollment_stats.pending }}</div>
                            <div class="ad-kpi-label">Pending Payments</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cover Image Panel -->
            {% if course.cover_image %}
            <div class="panel">
                <h3 class="panel-title">Cover Image</h3>
                <img src="{{ course.cover_image.url }}" alt="{{ course.title }}" class="cover-image">
            </div>
            {% endif %}

            <!-- Preview PDF Panel -->
            {% if course.preview_pdf %}
            <div class="panel">
                <h3 class="panel-title">Preview PDF</h3>
                <a href="{{ course.preview_pdf.url }}" target="_blank" class="btn btn-primary btn-full">
                    üìÑ View Preview PDF
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle PDF delete button clicks
    const deleteButtons = document.querySelectorAll('.delete-pdf-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const pdfId = this.getAttribute('data-pdf-id');
            const pdfTitle = this.getAttribute('data-pdf-title');
            
            // Show confirmation dialog
            const confirmed = confirm(
                `‚ö†Ô∏è Delete PDF?\n\n` +
                `PDF: "${pdfTitle}"\n\n` +
                `This will permanently delete the PDF file from storage. ` +
                `Students will lose access to this content.\n\n` +
                `This action cannot be undone. Are you sure?`
            );
            
            if (confirmed) {
                // Submit the hidden form
                const form = document.getElementById(`delete-form-${pdfId}`);
                if (form) {
                    form.submit();
                }
            }
        });
    });
});
</script>
{% endblock %}
