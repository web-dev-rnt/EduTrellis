{% extends "admin_dashboard.html" %}
{% load static %}

{% block content %}
{% include 'message.html' %}
<style>
/* Form Layout Container */
.form-layout {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.form-main-column {
    flex: 2;
    min-width: 0;
}

.form-sidebar-column {
    flex: 1;
    min-width: 280px;
}

/* Inner Form Rows */
.form-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.form-col-half {
    flex: 1;
    min-width: 0;
}

.form-col-third {
    flex: 1;
    min-width: 0;
}

/* Image Preview */
.image-preview {
    margin-bottom: 8px;
}

.preview-image {
    max-width: 100%;
    border-radius: 4px;
    display: block;
}

.preview-caption {
    font-size: 12px;
    color: var(--ad-muted);
    margin-top: 4px;
}

/* File Preview Box */
.file-preview-box {
    margin-bottom: 8px;
    padding: 8px;
    background: var(--ad-panel-2);
    border-radius: 4px;
}

/* Checkbox Label */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
    cursor: pointer;
}

/* Free Course Checkbox Special Styling */
.free-course-checkbox {
    padding: 12px;
    background: #f0fdf4;
    border: 2px solid #86efac;
    border-radius: 8px;
    font-weight: 500;
    margin-bottom: 16px;
}

.free-course-checkbox span {
    font-size: 15px;
}

/* Pricing Section */
.pricing-section {
    padding: 16px;
    background: var(--ad-panel-2);
    border-radius: 8px;
    margin-bottom: 16px;
}

.pricing-section.disabled {
    opacity: 0.5;
    pointer-events: none;
}

/* Delete Form Hidden */
.delete-form {
    display: none;
}

/* Responsive */
@media (max-width: 992px) {
    .form-layout {
        flex-direction: column;
    }
    
    .form-sidebar-column {
        width: 100%;
    }
}

@media (max-width: 640px) {
    .form-row {
        flex-direction: column;
    }
}
</style>

<div class="wrapper">
    <h1 class="h1">Edit E-Library Course</h1>
    <p class="small">Update "{{ course.title }}"</p>

    <div class="nav-buttons">
        <a href="{% url 'elibrary_manage' %}" class="btn">‚Üê Back to Library</a>
        <a href="{% url 'elibrary_course_detail' item.pk %}" class="btn">View Details</a>
        <button type="button" class="btn btn-danger" id="deleteCourseBtn">Delete Course</button>
    </div>

    <div class="panel">
        <form method="post" enctype="multipart/form-data" id="courseEditForm">
            {% csrf_token %}
            
            <div class="form-layout">
                <!-- Main Column -->
                <div class="form-main-column">
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}">Course Title*</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <ul class="errorlist">
                                {% for error in form.title.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.short_description.id_for_label }}">Short Description*</label>
                        {{ form.short_description }}
                        <div class="help-text">Brief overview displayed in course listings (max 300 characters)</div>
                        {% if form.short_description.errors %}
                            <ul class="errorlist">
                                {% for error in form.short_description.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}">Full Description*</label>
                        {{ form.description }}
                        <div class="help-text">Detailed course description with learning objectives and content overview</div>
                        {% if form.description.errors %}
                            <ul class="errorlist">
                                {% for error in form.description.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="form-row">
                        <div class="form-col-half">
                            <div class="form-group">
                                <label for="{{ form.category.id_for_label }}">Category*</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <ul class="errorlist">
                                        {% for error in form.category.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-col-half">
                            <div class="form-group">
                                <label for="{{ form.instructor.id_for_label }}">Instructor*</label>
                                {{ form.instructor }}
                                {% if form.instructor.errors %}
                                    <ul class="errorlist">
                                        {% for error in form.instructor.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col-third">
                            <div class="form-group">
                                <label for="{{ form.difficulty_level.id_for_label }}">Difficulty Level*</label>
                                {{ form.difficulty_level }}
                                {% if form.difficulty_level.errors %}
                                    <ul class="errorlist">
                                        {% for error in form.difficulty_level.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-col-third">
                            <div class="form-group">
                                <label for="{{ form.total_pages.id_for_label }}">Total Pages*</label>
                                {{ form.total_pages }}
                                <div class="help-text">Approximate total pages across all PDFs</div>
                                {% if form.total_pages.errors %}
                                    <ul class="errorlist">
                                        {% for error in form.total_pages.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-col-third">
                            <div class="form-group">
                                <label for="{{ form.language.id_for_label }}">Language*</label>
                                {{ form.language }}
                                {% if form.language.errors %}
                                    <ul class="errorlist">
                                        {% for error in form.language.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="pricing-section" id="pricingSectionWrapper">
                        <div class="form-group">
                            <label class="checkbox-label free-course-checkbox">
                                {{ form.is_free }}
                                <span>üéÅ Make this course FREE for all users</span>
                            </label>
                            <div class="help-text">Enable this to offer the course at no cost. Price fields will be disabled.</div>
                            {% if form.is_free.errors %}
                                <ul class="errorlist">
                                    {% for error in form.is_free.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>

                        <div id="pricingFields">
                            <div class="form-row">
                                <div class="form-col-half">
                                    <div class="form-group">
                                        <label for="{{ form.price.id_for_label }}">Price (‚Çπ)*</label>
                                        {{ form.price }}
                                        {% if form.price.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.price.errors %}
                                                    <li>{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-col-half">
                                    <div class="form-group">
                                        <label for="{{ form.discount_price.id_for_label }}">Discount Price (‚Çπ)</label>
                                        {{ form.discount_price }}
                                        <div class="help-text">Leave blank for no discount</div>
                                        {% if form.discount_price.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.discount_price.errors %}
                                                    <li>{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.tags.id_for_label }}">Tags</label>
                        {{ form.tags }}
                        <div class="help-text">Comma-separated keywords for searchability (e.g., "mathematics, algebra, geometry")</div>
                        {% if form.tags.errors %}
                            <ul class="errorlist">
                                {% for error in form.tags.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>

                <!-- Sidebar Column -->
                <div class="form-sidebar-column">
                    <div class="form-group">
                        <label for="{{ form.cover_image.id_for_label }}">Cover Image</label>
                        {% if course.cover_image %}
                            <div class="image-preview">
                                <img src="{{ course.cover_image.url }}" alt="Current cover" class="preview-image">
                                <div class="preview-caption">Current cover image</div>
                            </div>
                        {% endif %}
                        {{ form.cover_image }}
                        <div class="help-text">Recommended: 800x600px, max 2MB</div>
                        {% if form.cover_image.errors %}
                            <ul class="errorlist">
                                {% for error in form.cover_image.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.preview_pdf.id_for_label }}">Preview PDF</label>
                        {% if course.preview_pdf %}
                            <div class="file-preview-box">
                                <strong>Current:</strong> {{ course.preview_pdf.name|slice:"20:" }}
                            </div>
                        {% endif %}
                        {{ form.preview_pdf }}
                        <div class="help-text">Free preview PDF for students (optional)</div>
                        {% if form.preview_pdf.errors %}
                            <ul class="errorlist">
                                {% for error in form.preview_pdf.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            {{ form.is_featured }}
                            <span>Featured Course</span>
                        </label>
                        <div class="help-text">Display prominently on homepage</div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            {{ form.is_bestseller }}
                            <span>Bestseller Badge</span>
                        </label>
                        <div class="help-text">Show bestseller badge on course</div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            {{ form.is_active }}
                            <span>Active</span>
                        </label>
                        <div class="help-text">Make course visible to students</div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary">Update Course</button>
                <a href="{% url 'elibrary_manage' %}" class="btn">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Hidden Delete Form -->
<form method="post" action="{% url 'elibrary_course_delete' item.pk %}" class="delete-form" id="deleteCourseForm">
    {% csrf_token %}
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Delete Course Handler
    const deleteCourseBtn = document.getElementById('deleteCourseBtn');
    const deleteCourseForm = document.getElementById('deleteCourseForm');
    
    deleteCourseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const confirmed = confirm(
            '‚ö†Ô∏è DELETE ENTIRE COURSE?\n\n' +
            'Course: "{{ course.title }}"\n' +
            'Total PDFs: {{ course.total_pdfs }}\n\n' +
            'This will permanently delete:\n' +
            '‚Ä¢ All {{ course.total_pdfs }} PDF files from storage\n' +
            '‚Ä¢ Course cover image and preview PDF\n' +
            '‚Ä¢ All enrollment records\n' +
            '‚Ä¢ All download statistics\n\n' +
            'Students will lose access to this content!\n\n' +
            'This action CANNOT be undone!\n\n' +
            'Type the course title to confirm deletion.\n' +
            'Are you absolutely sure?'
        );
        
        if (confirmed) {
            deleteCourseForm.submit();
        }
    });

    // Handle Free Course Toggle
    const isFreeCheckbox = document.querySelector('#id_is_free');
    const pricingFields = document.querySelector('#pricingFields');
    const priceInput = document.querySelector('#id_price');
    const discountPriceInput = document.querySelector('#id_discount_price');
    
    if (isFreeCheckbox && pricingFields) {
        function togglePricingFields() {
            if (isFreeCheckbox.checked) {
                pricingFields.classList.add('disabled');
                // Store current values before disabling
                if (priceInput.value !== '0.00' && priceInput.value !== '0' && priceInput.value !== '') {
                    priceInput.dataset.originalValue = priceInput.value;
                }
                priceInput.value = '0.00';
                discountPriceInput.value = '';
                priceInput.removeAttribute('required');
            } else {
                pricingFields.classList.remove('disabled');
                priceInput.setAttribute('required', 'required');
                // Restore original value if it was stored
                if (priceInput.dataset.originalValue) {
                    priceInput.value = priceInput.dataset.originalValue;
                    delete priceInput.dataset.originalValue;
                } else if (priceInput.value === '0.00' || priceInput.value === '0') {
                    priceInput.value = '';
                }
            }
        }
        
        // Initial check on page load
        togglePricingFields();
        
        // Listen for changes
        isFreeCheckbox.addEventListener('change', togglePricingFields);
    }
});
</script>
{% endblock %}
