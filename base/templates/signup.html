{% extends "base.html" %}
{% load static %}
{% block content %}
{% include 'message.html' %}
<div class="signup-page">
  <div class="login-background">
    <div class="login-card signup-card">
      <div class="login-form-container signup-form-container">
        <div class="login-welcome">Create Your Account</div>

        <form class="login-form" id="signupForm" method="post" action="{% url 'signup' %}" enctype="multipart/form-data" novalidate>
          {% csrf_token %}

          <!-- Personal Information -->
          <div class="section-title" style="margin-top:0;">Personal Information</div>
          
          <div class="form-row-group">
            <div class="input-wrapper">
              {{ form.first_name }}
              {% if form.first_name.errors %}
                <div class="field-error">{{ form.first_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.middle_name }}
              {% if form.middle_name.errors %}
                <div class="field-error">{{ form.middle_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.last_name }}
              {% if form.last_name.errors %}
                <div class="field-error">{{ form.last_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.age }}
              {% if form.age.errors %}
                <div class="field-error">{{ form.age.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.gender }}
              {% if form.gender.errors %}
                <div class="field-error">{{ form.gender.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.contact_number }}
              {% if form.contact_number.errors %}
                <div class="field-error">{{ form.contact_number.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Account Information -->
          <div class="section-title">Account Information</div>
          
          <div class="form-row-group">
            <div class="input-wrapper full-width">
              {{ form.email }}
              {% if form.email.errors %}
                <div class="field-error">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper full-width">
              <label for="{{ form.profile_image.id_for_label }}" class="file-label">
                <i class="fa fa-upload"></i> Profile Picture (Optional)
              </label>
              {{ form.profile_image }}
              <div id="fileName" class="file-name"></div>
              {% if form.profile_image.errors %}
                <div class="field-error">{{ form.profile_image.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.password }}
              <div id="passwordStrength" class="password-strength"></div>
              {% if form.password.errors %}
                <div class="field-error">{{ form.password.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="input-wrapper">
              {{ form.confirm_password }}
              <div id="passwordMatch" class="password-match"></div>
              {% if form.confirm_password.errors %}
                <div class="field-error">{{ form.confirm_password.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Non-field errors -->
          {% if form.non_field_errors %}
            <div class="form-errors">
              {% for error in form.non_field_errors %}
                <div class="field-error">{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Submit Button -->
          <button type="submit" class="login-btn" id="signupSubmitBtn">
            <span class="btn-label">
              {% if smtp_configured %}
                Sign Up & Send Verification
              {% else %}
                Create Account
              {% endif %}
            </span>
            <span class="btn-spinner" id="signupBtnSpinner" style="display:none;margin-left:8px;">
              <span class="spinner"></span>
            </span>
          </button>

          <div class="login-signup">
            Already have an account? <a href="{% url 'login' %}">Log in</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
/* Form Styling */
.form-row-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.input-wrapper {
  position: relative;
}

.input-wrapper.full-width {
  grid-column: 1 / -1;
}

.form-input,
.form-input-file {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s ease;
  background: #fff;
}

.form-input:focus {
  outline: none;
  border-color: #4285f4;
  box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

.form-input::placeholder {
  color: #999;
}

/* File Input Styling */
.form-input-file {
  display: none;
}

.file-label {
  display: inline-block;
  padding: 12px 20px;
  background: #f5f5f5;
  border: 2px dashed #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  width: 95%;
  color: #666;
  font-size: 14px;
}

.file-label:hover {
  background: #e8e8e8;
  border-color: #4285f4;
  color: #4285f4;
}

.file-label i {
  margin-right: 8px;
}

.file-name {
  margin-top: 8px;
  font-size: 13px;
  color: #666;
  font-style: italic;
}

/* Error Styling */
.field-error {
  color: #d93025;
  font-size: 12px;
  margin-top: 5px;
  display: block;
  line-height: 1.3;
  border-left: 2px solid #d93025;
  padding-left: 8px;
}

.form-errors {
  margin-bottom: 15px;
}

/* Password Indicators */
.password-strength,
.password-match {
  font-size: 12px;
  margin-top: 5px;
  font-weight: 500;
}

/* Section Title */
.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 25px 0 15px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid #f0f0f0;
}

/* Button Spinner */
.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .form-row-group {
    grid-template-columns: 1fr;
    gap: 15px;
  }
}
</style>

<script>
(function () {
  const form = document.getElementById('signupForm');
  const btn = document.getElementById('signupSubmitBtn');
  const spinner = document.getElementById('signupBtnSpinner');
  const label = btn?.querySelector('.btn-label');

  // Form submission loader
  if (form) {
    form.addEventListener('submit', function () {
      if (btn) { 
        btn.disabled = true; 
        btn.classList.add('is-loading'); 
      }
      if (label) {
        label.textContent = {% if smtp_configured %}'Creating account & sending verification...'{% else %}'Creating account...'{% endif %};
      }
      if (spinner) spinner.style.display = 'inline-block';
    });
  }

  // File input display
  const fileInput = document.getElementById('{{ form.profile_image.id_for_label }}');
  const fileName = document.getElementById('fileName');
  
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        fileName.textContent = '✓ ' + this.files[0].name;
        fileName.style.color = '#34a853';
      } else {
        fileName.textContent = '';
      }
    });
  }

  // Password strength indicator
  const pwd = document.getElementById('{{ form.password.id_for_label }}');
  const strength = document.getElementById('passwordStrength');

  function showStrength(value) {
    if (!strength) return;
    if (!value) { 
      strength.textContent = ''; 
      return; 
    }
    
    let score = 0;
    if (value.length >= 8) score++;
    if (/[A-Z]/.test(value)) score++;
    if (/[a-z]/.test(value)) score++;
    if (/\d/.test(value)) score++;
    if (/[^A-Za-z0-9]/.test(value)) score++;
    
    const labels = ['Very weak', 'Weak', 'Fair', 'Good', 'Strong', 'Very strong'];
    const colors = ['#d93025', '#ea4335', '#fbbc04', '#34a853', '#137333', '#0d652d'];
    
    strength.textContent = 'Strength: ' + labels[score];
    strength.style.color = colors[score];
  }

  if (pwd) {
    pwd.addEventListener('input', function () { 
      showStrength(pwd.value);
      checkMatch();
    });
  }

  // Password match indicator
  const cpwd = document.getElementById('{{ form.confirm_password.id_for_label }}');
  const matchIndicator = document.getElementById('passwordMatch');

  function checkMatch() {
    if (!pwd || !cpwd || !matchIndicator) return;
    
    if (cpwd.value && pwd.value !== cpwd.value) {
      matchIndicator.textContent = '✗ Passwords do not match';
      matchIndicator.style.color = '#d93025';
    } else if (cpwd.value && pwd.value === cpwd.value) {
      matchIndicator.textContent = '✓ Passwords match';
      matchIndicator.style.color = '#34a853';
    } else {
      matchIndicator.textContent = '';
    }
  }

  if (cpwd) {
    cpwd.addEventListener('input', checkMatch);
  }
})();
</script>

{% endblock content %}
